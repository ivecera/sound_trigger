/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>

#include <stdarg.h>


//-------------------------------------------------------------------------
// Function declarations

void _on_dlclose();
int __fastcall set_device_enable(int a1, int a2);
int open_dump_file();
int sprintf(int a1, int a2, int a3, ...);
int close_dump_file();
int pcm_get_state();
int __fastcall pcm_set_state(int);
int __fastcall handle_device_switch(int, int);
int open_pcm_device();
int close_pcm_device();
void *__fastcall packet_to_planer(__int16 *, _WORD *, int);
int pcm_start_read();
int pcm_stop_read();
int pcm_pause_read();
int __fastcall pcm_resume_read(int);
int __fastcall pcm_handle_ssr(int);
int __fastcall pcm_init(uint32_t);
int pcm_handle_reset();
int __fastcall pcm_transfer_to_barge_in(int);
int platform_info_get();
int sound_trigger_pcm_close();
void pcm_deinit();
int __fastcall pcm_read_loop(struct context *a1);
int __fastcall sound_trigger_hw_call_back(int, int *);
uint32_t hal_get_state();
int __fastcall hal_set_state(uint32_t a1);
int wakeup_call_back();
int __fastcall stdev_get_properties(const struct sound_trigger_hw_device *dev, struct sound_trigger_properties *properties);
int __fastcall callback_thread_loop(sound_trigger_hw_device *st_device);
int dereg_hal_event_session();
int __fastcall sse_reset(int);
int sse_get_ref_channel();
int sse_get_mic_channel();
int sse_get_frame_size();
int sse_init();
int sse_deinit();
int __fastcall save_pcm_data1(char *a1, size_t a2);
int __fastcall sse_write_pcm_data1(char *a1, size_t a2);
int __fastcall sse_read_pcm_data1(char *, size_t);
int __fastcall update_wr_rt_ptr1(int a1, int a2);
int init_wr_rt_ptr1();
int __fastcall save_pcm_data(char *a1, size_t a2);
int exit_buffer_state();
int clear_buffer_state();
int __fastcall sse_write_pcm_data(char *, size_t);
int __fastcall sse_read_pcm_data(char *, size_t);
int __fastcall sva_read_pcm(char *, signed int);
int sse_dump_pcm_data();
unsigned int __fastcall update_wr_rt_ptr(int, int);
int init_wr_rt_ptr();
int __fastcall sse_process(void *src, int, void *dest, size_t n); // idb
int platform_init();
int __fastcall set_mixer_int(const char *name, int value);
int __fastcall set_mixer_string(const char *a1, const char *a2);
int __fastcall set_mixer_array(int a1, int *a2, int a3);
int __fastcall set_mixer_path(const char *a1, int a2);
int enable_ref_device();
int disable_ref_device();
int __fastcall set_mic_path(int);
int enable_top_mic();
int disable_top_mic();
int enable_headset_mic();
int disable_headset_mic();
int send_app_type();
int send_barge_in_app_type();
int __fastcall mxe_load_sound_model(int, unsigned int);
int load_sound_module();
int mxe_reset();
int mxe_create();
int mxe_init();
void mxe_deinit();
int __fastcall mxe_process(char *, int);
int sprintf(int a1, int a2, int a3, ...);
int __fastcall sub_78B8(unsigned int a1, unsigned int a2, int a3, int a4);
void *_aeabi_memcpy8(void *dest, const void *src, size_t n); // idb
void *_aeabi_memmove8(void *dest, const void *src, size_t n); // idb
void *__fastcall _aeabi_memset8(void *a1, size_t n, int c);
void *__fastcall _aeabi_memclr8(void *a1, size_t n);
int _ThumbV7PILongThunk_enable_headset_mic();
int _ThumbV7PILongThunk_enable_top_mic();
int _ThumbV7PILongThunk_disable_headset_mic();
int _ThumbV7PILongThunk_disable_top_mic();
int _ThumbV7PILongThunk___android_log_print(int a1, int a2, const char *a3, ...);
int __fastcall _ThumbV7PILongThunk_fclose(FILE *stream);
int __fastcall _ThumbV7PILongThunk_pthread_mutex_unlock(pthread_mutex_t *mutex);
void __fastcall _ThumbV7PILongThunk_free(void *ptr);
int __fastcall _ThumbV7PILongThunk_init_wr_rt_ptr1(int a1);
int __fastcall _ThumbV7PILongThunk_save_pcm_data(char *a1, size_t a2);
int __fastcall _ThumbV7PILongThunk_sse_write_pcm_data(char *a1, size_t a2);
int __fastcall _ThumbV7PILongThunk_set_mixer_string(const char *a1, const char *a2);
int __fastcall _ThumbV7PILongThunk_set_mixer_int(const char *name, int value);
void sub_79A0();
// int _android_log_print(_DWORD, _DWORD, const char *, ...); weak
int j_enable_headset_mic();
int j_enable_top_mic();
int j_disable_headset_mic();
int j_disable_top_mic();
// int pthread_mutex_lock(pthread_mutex_t *mutex);
// int pthread_mutex_unlock(pthread_mutex_t *mutex);
void *__fastcall j___aeabi_memclr8(void *a1, size_t n);
// int __fastcall property_get(_DWORD, _DWORD, _DWORD); weak
// FILE *fopen(const char *filename, const char *modes);
// int _vsprintf_chk(_DWORD, _DWORD, _DWORD, const char *, ...); weak
// int fflush(FILE *stream);
// int fclose(FILE *stream);
int j_sse_get_mic_channel();
int j_enable_ref_device();
int __fastcall j_set_device_enable(int a1, int a2);
int j_send_barge_in_app_type();
int j_send_app_type();
int __fastcall j_set_mic_path(int a1);
// int __fastcall pcm_open(_DWORD, _DWORD, _DWORD, _DWORD); weak
// int __fastcall pcm_is_ready(_DWORD); weak
// int __fastcall pcm_get_buffer_size(_DWORD); weak
// int __fastcall pcm_frames_to_bytes(_DWORD, _DWORD); weak
// int __fastcall pcm_get_error(_DWORD); weak
int j_disable_ref_device();
// int __fastcall pcm_close(_DWORD); weak
void *__fastcall j___aeabi_memclr8_0(void *a1, size_t n);
void *j___aeabi_memcpy8(void *dest, const void *src, size_t n); // idb
int __fastcall j_exit_buffer_state();
// int pthread_cond_signal(pthread_cond_t *cond);
// void *calloc(size_t nmemb, size_t size);
int __fastcall j_platform_init(int);
int j_sse_get_ref_channel();
// void *malloc(size_t size);
int j_sse_get_frame_size();
// int pthread_mutex_init(pthread_mutex_t *mutex, const pthread_mutexattr_t *mutexattr);
// void free(void *ptr);
// void *dlopen(const char *file, int mode);
// void *dlsym(void *handle, const char *name);
int j_sse_init();
int j_mxe_init();
int j_platform_info_get();
void j_mxe_deinit();
int j_sse_deinit();
int __fastcall j_pcm_set_state(int a1);
// int pthread_join(pthread_t th, void **thread_return);
// int setpriority(__priority_which_t which, id_t who, int prio);
// int __fastcall set_sched_policy(int, int);
int j_pcm_get_state();
int __fastcall j_sse_reset(int a1);
int j_mxe_reset();
int j_open_dump_file();
// int __fastcall pcm_read(_DWORD, _DWORD, _DWORD); weak
void *__fastcall j_packet_to_planer(__int16 *a1, _WORD *a2, int a3);
// size_t fwrite(const void *ptr, size_t size, size_t n, FILE *s);
int __fastcall j_sse_process(void *src, int, void *dest, size_t n); // idb
int j_close_dump_file();
int j_close_pcm_device();
// int pthread_cond_wait(pthread_cond_t *cond, pthread_mutex_t *mutex);
int j_clear_buffer_state();
int j_open_pcm_device();
int __fastcall j_sva_read_pcm(char *a1, signed int a2);
int j_pcm_start_read();
int j_pcm_stop_read();
int __fastcall j_pcm_transfer_to_barge_in(int);
int __fastcall j_handle_device_switch(int a1, int a2);
int j_pcm_pause_read();
int j_pcm_handle_reset();
int __fastcall j_pcm_handle_ssr(int);
int __fastcall j_pcm_resume_read(int);
int j_sound_trigger_pcm_close();
int __fastcall j_mxe_load_sound_model(int, unsigned int);
void *j___aeabi_memcpy8_0(void *dest, const void *src, size_t n); // idb
int __fastcall j_init_wr_rt_ptr(int);
int __fastcall j_init_wr_rt_ptr1(int);
// int pthread_cond_init(pthread_cond_t *cond, const pthread_condattr_t *cond_attr);
// int clock_gettime(clockid_t clock_id, struct timespec *tp);
// int pthread_cond_timedwait(pthread_cond_t *cond, pthread_mutex_t *mutex, const struct timespec *abstime);
int __fastcall j_sse_read_pcm_data(char *, size_t);
int __fastcall j_sse_read_pcm_data1(char *, size_t);
int __fastcall j_mxe_process(char *a1, int a2);
int __fastcall j_save_pcm_data(char *, size_t);
int __fastcall j_sse_write_pcm_data(char *a1, size_t a2);
// int __fastcall mixer_open(_DWORD); weak
// int __fastcall mixer_get_ctl_by_name(_DWORD, _DWORD); weak
// int __fastcall mixer_ctl_set_value(_DWORD, _DWORD, _DWORD); weak
// int __fastcall mixer_ctl_set_enum_by_string(_DWORD, _DWORD); weak
// int __fastcall mixer_ctl_set_array(_DWORD, _DWORD, _DWORD); weak
int __fastcall j_set_mixer_int(const char *name, int value);
int __fastcall j_set_mixer_string(const char *, const char *);
// int __fastcall _memcpy_chk(_DWORD, _DWORD, _DWORD, _DWORD); weak
int __fastcall j_mxe_create(int);
// size_t fread_unlocked(void *ptr, size_t size, size_t n, FILE *stream);
// int __fastcall PaddyEngineStopTask(_DWORD, _DWORD); weak
// int __fastcall PaddyEngineCreateTask(_DWORD); weak
// int __fastcall PaddyEngineCreate(int);
// int PaddyEngineInit(void); weak
// int __fastcall PaddyEngineGetModelVersion(_DWORD, _DWORD); weak
// int __fastcall PaddyEngineDestroy(_DWORD); weak
void *j___aeabi_memmove8(void *dest, const void *src, size_t n); // idb
// int __fastcall PaddyEngineProcessTask(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD); weak
void *j___aeabi_memcpy8_1(void *dest, const void *src, size_t n); // idb
int __fastcall j_save_pcm_data1(char *a1, size_t a2);
int __fastcall j_sse_write_pcm_data1(char *a1, size_t a2);
int __fastcall j_update_wr_rt_ptr1(int a1, int a2);
unsigned int __fastcall j_update_wr_rt_ptr(int a1, int a2);
int j_wakeup_call_back();
void *_aeabi_memcpy8_0(void *dest, const void *src, size_t n);
void *_aeabi_memmove8_0(void *dest, const void *src, size_t n);
// void *memset(void *s, int c, size_t n);
// void *memcpy(void *dest, const void *src, size_t n);
// void *memmove(void *dest, const void *src, size_t n);

//-------------------------------------------------------------------------
// Data declarations

int dword_0 = 1179403647; // weak
char byte_5 = '\x01'; // weak
int dword_A4 = 868; // weak
sound_trigger_properties hw_properties =
{
  {
    'X',
    'i',
    'a',
    'o',
    ' ',
    'M',
    'I',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0',
    '\0'
  },
  "Xiao ai tong xue",
  1u,
  { 3883987520u, 61492u, 4579u, 47002u, { 0u, 2u, 165u, 213u, 197u, 27u } },
  1u,
  1u,
  1u,
  1u,
  true,
  0u,
  false,
  false,
  20u
}; // weak
_UNKNOWN unk_3320; // weak
_UNKNOWN loc_70E0; // weak
_UNKNOWN loc_70E8; // weak
_UNKNOWN loc_7190; // weak
_UNKNOWN loc_7198; // weak
int *file_ch4_ptr[5] = { &file_ch4, &file_wakeup, &file_left, &file_rgiht, &AEC }; // weak
int *partial_buffer_ptr = &partial_buffer; // weak
char *out_put_ch_info = "mic"; // weak
struct context *_bss_start;
struct my_device my_dev;
int gmixer; // weak
int dword_A8AC; // weak
int partial_buffer; // weak
int partial_size; // weak
int paddy_task; // weak
int paddy_engine; // weak
int AEC; // weak
int file_ch1; // weak
int file_ch2; // weak
int file_ch3; // weak
int file_ch4; // weak
int file_left; // weak
int file_mic; // weak
int file_rgiht; // weak
int file_sse; // weak
int file_wakeup; // weak
int ftt_length; // weak
int head_length; // weak
int sAudioHeader; // weak
_UNKNOWN unk_FBB0; // weak
int ssedev; // weak
int ssedev1; // weak
_UNKNOWN result; // weak
int dword_FBC0; // weak
int dword_FBD8; // weak
_UNKNOWN unk_FBDC; // weak
// extern _UNKNOWN _stack_chk_guard; weak


//----- (00004390) --------------------------------------------------------
void _on_dlclose()
{
  char v0; // nf
  char v1; // vf
  int v2; // r8

  if ( v0 )
    __ldrt((unsigned int *)(v2 - 2049));
  if ( v0 == v1 )
    JUMPOUT(0x439C);
  JUMPOUT(0xFEBC03A8);
}
// 4398: control flows out of bounds to 439C
// 4394: control flows out of bounds to FEBC03A8
// 4390: variable 'v0' is possibly undefined
// 4390: variable 'v2' is possibly undefined
// 4394: variable 'v1' is possibly undefined

//----- (000043A4) --------------------------------------------------------
int __fastcall set_device_enable(int a1, int a2)
{
  const char *v4; // r3

  v4 = "enable";
  if ( !a2 )
    v4 = "disable";
  _android_log_print(3, "sound_trigger_hal", "%s  capture device%x", v4, a1);
  if ( a1 == -2147483632 )
  {
    if ( a2 )
      return _ThumbV7PILongThunk_enable_headset_mic();
    else
      return _ThumbV7PILongThunk_disable_headset_mic();
  }
  else if ( a2 )
  {
    return _ThumbV7PILongThunk_enable_top_mic();
  }
  else
  {
    return _ThumbV7PILongThunk_disable_top_mic();
  }
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (00004410) --------------------------------------------------------
int swtich_device()
{
  struct context *v0; // r0

  _android_log_print(3, "sound_trigger_hal", "swtich_device");
  pthread_mutex_lock(&_bss_start->lock);
  v0 = _bss_start;
  if ( _bss_start->state == 1 )
    _bss_start->state = 3;
  pthread_mutex_unlock(&v0->lock);
  return _ThumbV7PILongThunk___android_log_print(3, "sound_trigger_hal", "swtich_device exit");
}
// 7930: using guessed type int _ThumbV7PILongThunk___android_log_print(_DWORD, _DWORD, const char *, ...);
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (00004460) --------------------------------------------------------
int open_dump_file()
{
  int v0; // r1
  FILE *v1; // r0
  int *v2; // r1
  char v4[128]; // [sp+8h] [bp-118h] BYREF
  char v5[132]; // [sp+88h] [bp-98h] BYREF
  int v6; // [sp+10Ch] [bp-14h]

  memset(v5, 0, 0x80u);
  memset(v4, 0, sizeof(v4));
  property_get("audio.soundtrigger.debug.urser_id", v4, 0);
  sprintf((int)v5, v0, (int)"/data/misc/media/%s_%s.pcm", out_put_ch_info, v4);
  v1 = fopen(v5, "wb");
  v2 = &file_ch1;
  file_ch1 = (int)v1;
  if ( !v1 )
    _android_log_print(6, "sound_trigger_hal", "mic_ch1 open failed");
  sprintf((int)v5, (int)v2, (int)"/data/misc/media/sse_%s.pcm", v4);
  file_sse = (int)fopen(v5, "wb");
  if ( !file_sse )
    _android_log_print(6, "sound_trigger_hal", "Open file %s failed\n", v5);
  return _stack_chk_guard - v6;
}
// 449E: variable 'v0' is possibly undefined
// 44CE: variable 'v2' is possibly undefined
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 7A50: using guessed type int __fastcall property_get(_DWORD, _DWORD, _DWORD);
// A550: using guessed type char *out_put_ch_info;
// F8C0: using guessed type int file_ch1;
// F8DC: using guessed type int file_sse;

//----- (0000453C) --------------------------------------------------------
int sprintf(int a1, int a2, int a3, ...)
{
  int v4; // [sp+8h] [bp-10h]
  va_list va; // [sp+14h] [bp-4h] BYREF

  va_start(va, a3);
  _vsprintf_chk(a1, 0, 128, a3, (int *)va, (int *)va);
  return _stack_chk_guard - v4;
}
// 4564: variable 'v4' is possibly undefined
// 7A80: using guessed type int __fastcall _vsprintf_chk(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);

//----- (0000457C) --------------------------------------------------------
int close_dump_file()
{
  int result; // r0

  if ( file_mic )
    fflush((FILE *)file_mic);
  if ( file_ch1 )
    fflush((FILE *)file_ch1);
  if ( file_ch2 )
    fflush((FILE *)file_ch2);
  if ( file_ch3 )
    fflush((FILE *)file_ch3);
  if ( file_ch4 )
    fflush((FILE *)file_ch4);
  if ( file_sse )
    fflush((FILE *)file_sse);
  if ( file_wakeup )
    fflush((FILE *)file_wakeup);
  if ( file_mic )
    fclose((FILE *)file_mic);
  if ( file_ch1 )
    fclose((FILE *)file_ch1);
  if ( file_ch2 )
    fclose((FILE *)file_ch2);
  if ( file_ch3 )
    fclose((FILE *)file_ch3);
  if ( file_ch4 )
    fclose((FILE *)file_ch4);
  if ( file_sse )
    fclose((FILE *)file_sse);
  if ( file_left )
    fclose((FILE *)file_left);
  if ( file_rgiht )
    fclose((FILE *)file_rgiht);
  result = file_wakeup;
  if ( file_wakeup )
    return _ThumbV7PILongThunk_fclose((FILE *)file_wakeup);
  return result;
}
// F8C0: using guessed type int file_ch1;
// F8C4: using guessed type int file_ch2;
// F8C8: using guessed type int file_ch3;
// F8CC: using guessed type int file_ch4;
// F8D0: using guessed type int file_left;
// F8D4: using guessed type int file_mic;
// F8D8: using guessed type int file_rgiht;
// F8DC: using guessed type int file_sse;
// F8E0: using guessed type int file_wakeup;

//----- (00004674) --------------------------------------------------------
int pcm_get_state()
{
  int state; // r4

  pthread_mutex_lock(&_bss_start->lock);
  state = _bss_start->state;
  pthread_mutex_unlock(&_bss_start->lock);
  return state;
}

//----- (00004690) --------------------------------------------------------
int __fastcall pcm_set_state(int a1)
{
  struct context *v2; // r0

  _android_log_print(3, "sound_trigger_hal", "set to state %d", a1);
  pthread_mutex_lock(&_bss_start->lock);
  v2 = _bss_start;
  _bss_start->state = a1;
  return _ThumbV7PILongThunk_pthread_mutex_unlock(&v2->lock);
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (000046C8) --------------------------------------------------------
int __fastcall handle_device_switch(int a1, int a2)
{
  const char *v4; // r6
  struct context *v5; // r0
  __int64 v6; // kr00_8
  int v7; // r3
  const char *v9; // r7

  v4 = "Connected";
  if ( !a1 )
    v4 = "Disconnected";
  _android_log_print(3, "sound_trigger_hal", "%s: device 0x%x %s", "handle_device_switch", a2, v4);
  pthread_mutex_lock(&_bss_start->lock);
  v5 = _bss_start;
  v6 = *(_QWORD *)&_bss_start->capture_device;
  v7 = HIDWORD(v6) & ~a2;
  if ( a1 )
    v7 = HIDWORD(v6) | a2;
  _bss_start->available_device = v7;
  if ( a1 )
  {
    if ( (_DWORD)v6 != a2 )
    {
LABEL_7:
      pthread_mutex_unlock(&v5->lock);
      j_swtich_device();
      return _ThumbV7PILongThunk___android_log_print(2, "sound_trigger_hal", "%s: Exit", "handle_device_switch");
    }
  }
  else if ( (_DWORD)v6 == a2 )
  {
    goto LABEL_7;
  }
  v9 = "enabled";
  if ( !a1 )
    v9 = "disabled";
  _android_log_print(2, "sound_trigger_hal", "%s: device 0x%x already %s", "handle_device_switch", a2, v9);
  return _ThumbV7PILongThunk_pthread_mutex_unlock(_bss_start);
}
// 7930: using guessed type int _ThumbV7PILongThunk___android_log_print(_DWORD, _DWORD, const char *, ...);
// 7948: using guessed type int __fastcall _ThumbV7PILongThunk_pthread_mutex_unlock(_DWORD);
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (000047A4) --------------------------------------------------------
int open_pcm_device()
{
  struct context *v0; // r0
  int available_device; // r1
  int barge_in; // r1
  int v3; // r1
  void (__fastcall *acdb_loader_send_audio_cal_v3)(int, int, int, int, int); // r7
  int v5; // r0
  int v6; // r0
  int v7; // r4
  int buffer_size; // r0
  signed int dw0; // r0
  struct context *v10; // r5
  int v11; // r7
  void *mic_buf; // r1
  unsigned int mic_bufsize; // r3
  const char *error; // r0
  struct context *v15; // r1
  int pcm_device; // r0
  __int64 v18; // kr00_8
  char *v19; // r7
  int v20; // r0
  int v21; // [sp+0h] [bp-50h]
  int v22; // [sp+8h] [bp-48h] BYREF

  j_sse_get_mic_channel();
  _android_log_print(
    4,
    "sound_trigger_hal",
    "aavailable device %x,  capture device %x",
    _bss_start->available_device,
    _bss_start->capture_device);
  v0 = _bss_start;
  available_device = _bss_start->available_device;
  if ( (available_device & 0x10) != 0 )
  {
    _bss_start->capture_device = 0x80000010;
  }
  else if ( (available_device & 4) != 0 )
  {
    barge_in = _bss_start->barge_in;
    _bss_start->capture_device = 0x80000004;
    if ( barge_in )
    {
      j_enable_ref_device();
      v0 = _bss_start;
      v22 = 1;
    }
  }
  j_set_device_enable(v0->capture_device, 1);
  v3 = _bss_start->barge_in;
  LOBYTE(AEC) = v3 != 0;
  if ( !v3 )
  {
    j_send_app_type();
    acdb_loader_send_audio_cal_v3 = (void (__fastcall *)(int, int, int, int, int))_bss_start->acdb_loader_send_audio_cal_v3;
    if ( acdb_loader_send_audio_cal_v3 )
    {
      v21 = 0;
    }
    else
    {
      acdb_loader_send_audio_cal_v3 = (void (__fastcall *)(int, int, int, int, int))_bss_start->acdb_loader_send_audio_cal_v2;
      if ( !acdb_loader_send_audio_cal_v3 )
        goto LABEL_16;
    }
    v5 = 10003;
    goto LABEL_15;
  }
  j_send_barge_in_app_type();
  acdb_loader_send_audio_cal_v3 = (void (__fastcall *)(int, int, int, int, int))_bss_start->acdb_loader_send_audio_cal_v3;
  if ( acdb_loader_send_audio_cal_v3 )
  {
    v21 = 0;
LABEL_12:
    v5 = 10025;
LABEL_15:
    acdb_loader_send_audio_cal_v3(v5, 2, 69938, 16000, v21);
    goto LABEL_16;
  }
  acdb_loader_send_audio_cal_v3 = (void (__fastcall *)(int, int, int, int, int))_bss_start->acdb_loader_send_audio_cal_v2;
  if ( acdb_loader_send_audio_cal_v3 )
    goto LABEL_12;
LABEL_16:
  j_set_mic_path(1);
  v6 = pcm_open(0, 13, 0x10000000, &v22);
  v7 = v6;
  if ( v6 && pcm_is_ready(v6) )
  {
    buffer_size = pcm_get_buffer_size(v7);
    dw0 = pcm_frames_to_bytes(v7, buffer_size);
    v10 = _bss_start;
    v11 = _bss_start->barge_in;
    _bss_start->pcm_device = v7;
    v10->mic_bufsize = dw0;
    if ( v11 && v10->capture_device == 0x80000004 && v10->ref_channel )
    {
      mic_buf = v10->mic_buf;
      v10->dw0 = dw0;
      v10->dw1 = (uint32_t)mic_buf;
      v10->dw2 = (uint32_t)mic_buf + dw0;
      mic_bufsize = dw0;
      v10->dw3 = 0;
    }
    else
    {
      v18 = *(_QWORD *)&v10->ref_channel;
      v19 = (char *)v10->mic_buf;
      v20 = dw0 / v10->mic_channel;
      v10->dw0 = v20;
      v10->dw1 = (uint32_t)v19;
      v10->dw2 = 0;
      v10->dw3 = (uint32_t)&v19[HIDWORD(v18) * v20];
      memset(&v19[HIDWORD(v18) * v20], 0, v20 * v18);
      v11 = _bss_start->barge_in;
      dw0 = _bss_start->dw0;
      mic_bufsize = _bss_start->mic_bufsize;
    }
    _android_log_print(3, "sound_trigger_hal", "pcm size %d, one_channel_size %d, barge in %d", mic_bufsize, dw0, v11);
    return 0;
  }
  else
  {
    error = (const char *)pcm_get_error(v7);
    _android_log_print(6, "sound_trigger_hal", "Unable to open PCM device (%s)\n", error);
    if ( _bss_start->barge_in && _bss_start->capture_device == 0x80000004 )
      j_disable_ref_device();
    j_set_mic_path(0);
    j_set_device_enable(_bss_start->capture_device, 0);
    v15 = _bss_start;
    pcm_device = _bss_start->pcm_device;
    if ( pcm_device )
    {
      pcm_close(pcm_device);
      v15 = _bss_start;
    }
    v15->pcm_device = 0;
    return -1;
  }
}
// 4886: variable 'v21' is possibly undefined
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 7B20: using guessed type int __fastcall pcm_open(_DWORD, _DWORD, _DWORD, _DWORD);
// 7B30: using guessed type int __fastcall pcm_is_ready(_DWORD);
// 7B40: using guessed type int __fastcall pcm_get_buffer_size(_DWORD);
// 7B50: using guessed type int __fastcall pcm_frames_to_bytes(_DWORD, _DWORD);
// 7B60: using guessed type int __fastcall pcm_get_error(_DWORD);
// 7B80: using guessed type int __fastcall pcm_close(_DWORD);
// F8BC: using guessed type int AEC;

//----- (000049A0) --------------------------------------------------------
int close_pcm_device()
{
  struct context *v0; // r1
  int pcm_device; // r0
  int result; // r0

  j_set_mic_path(0);
  j_set_device_enable(_bss_start->capture_device, 0);
  j_disable_ref_device();
  v0 = _bss_start;
  pcm_device = _bss_start->pcm_device;
  if ( pcm_device )
  {
    pcm_close(pcm_device);
    v0 = _bss_start;
  }
  result = 0;
  v0->pcm_device = 0;
  return result;
}
// 7B80: using guessed type int __fastcall pcm_close(_DWORD);

//----- (000049D4) --------------------------------------------------------
void *__fastcall packet_to_planer(__int16 *a1, _WORD *a2, int a3)
{
  int v3; // r3
  __int16 *v4; // r12
  _WORD *v5; // lr
  __int16 v6; // t1

  if ( a3 >= 1 )
  {
    v3 = 0;
    v4 = a1;
    v5 = a2;
    do
    {
      v6 = *v4++;
      ++v3;
      *v5++ = v6;
    }
    while ( v3 != a3 );
  }
  return qmemcpy(a1, a2, 2 * a3);
}

//----- (000049F8) --------------------------------------------------------
int pcm_start_read()
{
  struct context *v0; // r0
  int state; // r1

  _android_log_print(
    3,
    "sound_trigger_hal",
    "%s barge in %d, state %d, force idle %d ",
    "pcm_start_read",
    _bss_start->barge_in,
    _bss_start->state,
    _bss_start->force_idle);
  pthread_mutex_lock(&_bss_start->lock);
  v0 = _bss_start;
  switch ( _bss_start->state )
  {
    case 0:
      state = 1;
      goto LABEL_6;
    case 2:
      j_exit_buffer_state();
      v0 = _bss_start;
      goto LABEL_5;
    case 3:
      if ( _bss_start->force_idle == 1 )
        _bss_start->force_idle = 0;
      break;
    case 4:
LABEL_5:
      state = 3;
LABEL_6:
      v0->state = state;
      break;
    default:
      _android_log_print(2, "sound_trigger_hal", "ignore state change");
      v0 = _bss_start;
      break;
  }
  pthread_cond_signal(&v0->cond);
  pthread_mutex_unlock(&_bss_start->lock);
  return _android_log_print(
           3,
           "sound_trigger_hal",
           "%s exit barge in %d, state %d, force idle %d ",
           "pcm_start_read",
           _bss_start->barge_in,
           _bss_start->state,
           _bss_start->force_idle);
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (00004AB8) --------------------------------------------------------
int pcm_stop_read()
{
  struct context *v0; // r0
  int state; // r1

  _android_log_print(
    3,
    "sound_trigger_hal",
    "%s barge in %d, state %d, force idle %d ",
    "pcm_stop_read",
    _bss_start->barge_in,
    _bss_start->state,
    _bss_start->force_idle);
  pthread_mutex_lock(&_bss_start->lock);
  v0 = _bss_start;
  state = _bss_start->state;
  if ( state != 1 )
  {
    if ( state == 3 )
    {
      _bss_start->force_idle = 1;
      goto LABEL_8;
    }
    if ( state != 2 )
    {
      _android_log_print(2, "sound_trigger_hal", "ignore state change");
      v0 = _bss_start;
      goto LABEL_8;
    }
    j_exit_buffer_state();
    v0 = _bss_start;
    _bss_start->state = 4;
  }
  v0->state = 0;
LABEL_8:
  pthread_mutex_unlock(&v0->lock);
  return _android_log_print(
           3,
           "sound_trigger_hal",
           "%s exit barge in %d, state %d, force idle %d ",
           "pcm_stop_read",
           _bss_start->barge_in,
           _bss_start->state,
           _bss_start->force_idle);
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (00004B68) --------------------------------------------------------
int pcm_pause_read()
{
  struct context *v0; // r0
  int state; // r1

  _android_log_print(
    3,
    "sound_trigger_hal",
    "%s barge in %d, state %d, force idle %d ",
    "pcm_pause_read",
    _bss_start->barge_in,
    _bss_start->state,
    _bss_start->force_idle);
  pthread_mutex_lock(&_bss_start->lock);
  v0 = _bss_start;
  state = _bss_start->state;
  if ( state == 3 )
  {
    _bss_start->force_idle = 1;
  }
  else if ( state == 1 )
  {
    _bss_start->state = 0;
  }
  else
  {
    _android_log_print(2, "sound_trigger_hal", "ignore state change");
    v0 = _bss_start;
  }
  pthread_mutex_unlock(&v0->lock);
  return _android_log_print(
           3,
           "sound_trigger_hal",
           "%s exit barge in %d, state %d, force idle %d ",
           "pcm_pause_read",
           _bss_start->barge_in,
           _bss_start->state,
           _bss_start->force_idle);
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (00004C08) --------------------------------------------------------
int __fastcall pcm_resume_read(int a1)
{
  struct context *v2; // r0
  int v3; // r1

  _android_log_print(
    3,
    "sound_trigger_hal",
    "%s barge in %d, state %d, force idle %d ",
    "pcm_resume_read",
    _bss_start->barge_in,
    _bss_start->state,
    _bss_start->force_idle);
  pthread_mutex_lock(&_bss_start->lock);
  v2 = _bss_start;
  switch ( _bss_start->state )
  {
    case 0:
      v3 = 1;
      goto LABEL_5;
    case 1:
      if ( a1 )
        goto LABEL_4;
      break;
    case 3:
      if ( _bss_start->force_idle == 1 )
        _bss_start->force_idle = 0;
      break;
    case 4:
LABEL_4:
      v3 = 3;
LABEL_5:
      _bss_start->state = v3;
      break;
    default:
      _android_log_print(2, "sound_trigger_hal", "ignore state change");
      v2 = _bss_start;
      break;
  }
  pthread_cond_signal(&v2->cond);
  pthread_mutex_unlock(&_bss_start->lock);
  return _android_log_print(
           3,
           "sound_trigger_hal",
           "%s exit barge in %d, state %d, force idle %d ",
           "pcm_resume_read",
           _bss_start->barge_in,
           _bss_start->state,
           _bss_start->force_idle);
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (00004CC4) --------------------------------------------------------
int __fastcall pcm_handle_ssr(int a1)
{
  const char *v2; // r2
  struct context *v3; // r0

  _android_log_print(3, "sound_trigger_hal", "pcm reinit for handle adsp ssr");
  pcm_deinit();
  pcm_init(0);
  pthread_mutex_lock(&_bss_start->lock);
  v2 = "set pcm state IDEL for handle adsp ssr";
  if ( a1 )
    v2 = "set pcm state RE_START for handle adsp ssr";
  _android_log_print(3, "sound_trigger_hal", v2);
  v3 = _bss_start;
  if ( a1 )
    a1 = 3;
  _bss_start->state = a1;
  pthread_cond_signal(&v3->cond);
  return _ThumbV7PILongThunk_pthread_mutex_unlock(&_bss_start->lock);
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (00004D30) --------------------------------------------------------
int __fastcall pcm_init(uint32_t a1)
{
  struct context *v2; // r0
  int v3; // r0
  int v4; // r0
  void (__fastcall *acdb_loader_send_audio_cal_v3)(int, int, int, int, int); // r7
  int v6; // r0
  int v7; // r4
  int buffer_size; // r0
  int mic_channel; // r0
  struct context *v10; // r4
  unsigned int mic_bufsize; // r1
  void *v12; // r0
  unsigned int v13; // r3
  unsigned int v14; // r4
  int frame_size; // r0
  void *v16; // r1
  struct context *v17; // r0
  int v18; // r4
  const char *error; // r0
  int v20; // r0
  int v21; // r0
  struct context *v22; // r1
  int pcm_device; // r0
  void *mic_buf; // r0
  void *dw4; // r0
  int v27; // [sp+0h] [bp-50h]
  _DWORD v28[4]; // [sp+8h] [bp-48h] BYREF
  double v29; // [sp+18h] [bp-38h]
  double v30; // [sp+20h] [bp-30h]
  int v31; // [sp+28h] [bp-28h]
  int v32; // [sp+2Ch] [bp-24h]

  v2 = (struct context *)calloc(1u, 0x5Cu);
  _bss_start = v2;
  if ( !v2 )
  {
    _android_log_print(6, "sound_trigger_hal", "Unable to malloc for pcm_device ");
    return -1;
  }
  v2->capture_device = 0x80000004;
  v2->available_device = 0x80000004;
  v2->dw5 = a1;
  v3 = sleep(3u);
  j_platform_init(v3);
  v31 = 0;
  v32 = 0;
  v28[3] = 4;
  v28[2] = 160;
  v29 = 0.0;
  v28[0] = 1;
  v28[1] = 16000;
  v30 = 0.0;
  j_enable_ref_device();
  v4 = _android_log_print(3, "sound_trigger_hal", "%s  capture device%x", "enable", 0x80000004);
  j_enable_top_mic(v4);
  j_set_mic_path(1);
  acdb_loader_send_audio_cal_v3 = (void (__fastcall *)(int, int, int, int, int))_bss_start->acdb_loader_send_audio_cal_v3;
  if ( acdb_loader_send_audio_cal_v3 )
  {
    v27 = 0;
LABEL_6:
    acdb_loader_send_audio_cal_v3(10003, 2, 69938, 16000, v27);
    goto LABEL_7;
  }
  acdb_loader_send_audio_cal_v3 = (void (__fastcall *)(int, int, int, int, int))_bss_start->acdb_loader_send_audio_cal_v2;
  if ( acdb_loader_send_audio_cal_v3 )
    goto LABEL_6;
LABEL_7:
  v6 = pcm_open(0, 13, 0x10000000, v28);
  v7 = v6;
  if ( !v6 || !pcm_is_ready(v6) )
  {
    error = (const char *)pcm_get_error(v7);
    v20 = _android_log_print(6, "sound_trigger_hal", "Unable to open PCM device (%s)\n", error);
LABEL_15:
    j_disable_ref_device(v20);
    j_set_mic_path(0);
    v21 = _android_log_print(3, "sound_trigger_hal", "%s  capture device%x", "disable", 0x80000004);
    j_disable_top_mic(v21);
    v22 = _bss_start;
    pcm_device = _bss_start->pcm_device;
    if ( pcm_device )
    {
      pcm_close(pcm_device);
      v22 = _bss_start;
    }
    mic_buf = v22->mic_buf;
    if ( mic_buf )
    {
      free(mic_buf);
      v22 = _bss_start;
    }
    dw4 = (void *)v22->dw4;
    if ( dw4 )
      free(dw4);
    return -1;
  }
  _bss_start->pcm_device = v7;
  buffer_size = pcm_get_buffer_size(v7);
  _bss_start->mic_bufsize = pcm_frames_to_bytes(v7, buffer_size);
  _bss_start->ref_channel = j_sse_get_ref_channel();
  mic_channel = j_sse_get_mic_channel();
  v10 = _bss_start;
  mic_bufsize = _bss_start->mic_bufsize;
  _bss_start->mic_channel = mic_channel;
  v12 = malloc(mic_bufsize);
  v10->mic_buf = v12;
  if ( !v12 )
  {
    v20 = _android_log_print(6, "sound_trigger_hal", "malloc mic pcm buffer error");
    goto LABEL_15;
  }
  v13 = v10->mic_bufsize;
  v10->dw1 = (uint32_t)v12;
  v10->dw2 = 0;
  _android_log_print(6, "sound_trigger_hal", "mic buffer is %d, mic ptr %p", v13, v12);
  v14 = _bss_start->mic_bufsize;
  frame_size = j_sse_get_frame_size();
  v16 = malloc(frame_size + v14);
  v17 = _bss_start;
  _bss_start->dw4 = (uint32_t)v16;
  if ( !v16 )
  {
    v20 = _android_log_print(6, "sound_trigger_hal", "malloc out  buffer error");
    goto LABEL_15;
  }
  v18 = 0;
  pthread_mutex_init(&v17->lock, 0);
  pthread_create(&_bss_start->thread, 0, (void *(*)(void *))pcm_read_loop, _bss_start);
  return v18;
}
// 4DE2: variable 'v27' is possibly undefined
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 79F0: using guessed type int __fastcall j_enable_top_mic(_DWORD);
// 7A10: using guessed type int __fastcall j_disable_top_mic(_DWORD);
// 7AC0: using guessed type int j_sse_get_mic_channel(void);
// 7AD0: using guessed type int j_enable_ref_device(void);
// 7B10: using guessed type int __fastcall j_set_mic_path(_DWORD);
// 7B20: using guessed type int __fastcall pcm_open(_DWORD, _DWORD, _DWORD, _DWORD);
// 7B30: using guessed type int __fastcall pcm_is_ready(_DWORD);
// 7B40: using guessed type int __fastcall pcm_get_buffer_size(_DWORD);
// 7B50: using guessed type int __fastcall pcm_frames_to_bytes(_DWORD, _DWORD);
// 7B60: using guessed type int __fastcall pcm_get_error(_DWORD);
// 7B70: using guessed type int __fastcall j_disable_ref_device(_DWORD);
// 7B80: using guessed type int __fastcall pcm_close(_DWORD);
// 7C10: using guessed type int j_sse_get_ref_channel(void);

//----- (00004F48) --------------------------------------------------------
int pcm_handle_reset()
{
  struct context *v0; // r0

  pthread_mutex_lock(&_bss_start->lock);
  _android_log_print(3, "sound_trigger_hal", "set pcm state RE_START for map exit at background");
  v0 = _bss_start;
  _bss_start->state = 3;
  pthread_cond_signal(&v0->cond);
  return _ThumbV7PILongThunk_pthread_mutex_unlock(&_bss_start->lock);
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (00004F84) --------------------------------------------------------
int __fastcall pcm_transfer_to_barge_in(int a1)
{
  struct context *v2; // r0

  _android_log_print(
    3,
    "sound_trigger_hal",
    "%s barge in %d, state %d, force idle %d ",
    "pcm_transfer_to_barge_in",
    _bss_start->barge_in,
    _bss_start->state,
    _bss_start->force_idle);
  pthread_mutex_lock(&_bss_start->lock);
  v2 = _bss_start;
  _bss_start->barge_in = a1;
  pthread_mutex_unlock(&v2->lock);
  return _android_log_print(
           3,
           "sound_trigger_hal",
           "%s exit barge in %d, state %d, force idle %d ",
           "pcm_transfer_to_barge_in",
           _bss_start->barge_in,
           _bss_start->state,
           _bss_start->force_idle);
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (00004FF0) --------------------------------------------------------
int platform_info_get()
{
  struct context *v0; // r5
  void *v1; // r0
  void *v2; // r0
  void *v3; // r0

  v0 = _bss_start;
  v1 = dlopen("libacdbloader.so", 0);
  v0->acdb_handle = (uint32_t)v1;
  if ( v1 )
  {
    _android_log_print(2, "sound_trigger_hal", "%s: DLOPEN successful for %s", "platform_info_get", "libacdbloader.so");
    v2 = dlsym((void *)v0->acdb_handle, "acdb_loader_send_audio_cal_v2");
    v0->acdb_loader_send_audio_cal_v2 = (uint32_t)v2;
    if ( !v2 )
      _android_log_print(
        6,
        "sound_trigger_hal",
        "%s: Could not find the symbol acdb_send_audio_cal_v2 from %s",
        "platform_info_get",
        "libacdbloader.so");
    v3 = dlsym((void *)v0->acdb_handle, "acdb_loader_send_audio_cal_v3");
    v0->acdb_loader_send_audio_cal_v3 = (uint32_t)v3;
    if ( !v3 )
      _android_log_print(
        6,
        "sound_trigger_hal",
        "%s: Could not find the symbol acdb_send_audio_cal_v3 from %s",
        "platform_info_get",
        "libacdbloader.so");
  }
  else
  {
    _android_log_print(6, "sound_trigger_hal", "%s: DLOPEN failed for %s", "platform_info_get", "libacdbloader.so");
  }
  if ( v0->acdb_loader_send_audio_cal_v2 || v0->acdb_loader_send_audio_cal_v3 )
    return 0;
  else
    return -1;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (000050B4) --------------------------------------------------------
int __fastcall sound_trigger_pcm_open(uint32_t a1)
{
  int v2; // r4
  int v3; // r0
  int v4; // r0

  _android_log_print(3, "sound_trigger_hal", "enter sound_trigger_pcm_open");
  v2 = j_sse_init();
  if ( !v2 )
  {
    v2 = j_mxe_init();
    if ( !v2 )
    {
      v3 = pcm_init(a1);
      v2 = v3;
      if ( !v3 )
      {
        v4 = j_platform_info_get();
        if ( !v4 )
          return 0;
        v2 = v4;
        v3 = pcm_deinit();
      }
      j_mxe_deinit(v3);
    }
    j_sse_deinit();
  }
  return v2;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 7CA0: using guessed type int j_mxe_init(void);
// 7CB0: using guessed type int j_platform_info_get(void);
// 7CC0: using guessed type int __fastcall j_mxe_deinit(_DWORD);

//----- (00005104) --------------------------------------------------------
int sound_trigger_pcm_close()
{
  int v0; // r0

  pcm_deinit();
  v0 = j_sse_deinit();
  j_mxe_deinit(v0);
  return 0;
}
// 7CC0: using guessed type int __fastcall j_mxe_deinit(_DWORD);

//----- (00005118) --------------------------------------------------------
void pcm_deinit()
{
  void **v0; // r0

  j_pcm_set_state(5);
  pthread_cond_signal(&_bss_start->cond);
  if ( pthread_join(_bss_start->thread, 0) <= -1 )
  {
    _ThumbV7PILongThunk___android_log_print(
      6,
      (int)"sound_trigger_hal",
      "%s:Unable to join the calibration thread",
      "pcm_deinit");
  }
  else
  {
    j_disable_ref_device();
    j_set_mic_path(0);
    _android_log_print(3, "sound_trigger_hal", "%s  capture device%x", "disable", -2147483644);
    j_disable_top_mic();
    v0 = (void **)_bss_start;
    if ( _bss_start->pcm_device )
    {
      pcm_close(_bss_start->pcm_device);
      v0 = (void **)_bss_start;
    }
    if ( v0[10] )
    {
      free(v0[10]);
      v0 = (void **)_bss_start;
    }
    if ( v0[14] )
    {
      free(v0[14]);
      v0 = (void **)_bss_start;
    }
    _ThumbV7PILongThunk_free(v0);
  }
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 7B80: using guessed type int __fastcall pcm_close(_DWORD);

//----- (000051CC) --------------------------------------------------------
int __fastcall pcm_read_loop(struct context *a1)
{
  int **v1; // r0
  _WORD *v2; // r4
  FILE *v3; // r3
  size_t dw0; // r2
  const void *dw1; // r0
  struct context *v6; // r1
  int *p_state; // r0
  int v8; // r2
  int *state; // r2

  _android_log_print(3, "sound_trigger_hal", "enter pcm read loop %p", a1);
  setpriority(0, 0, -19);
  set_sched_policy(0, 1);
  if ( j_pcm_get_state() == 5 )
    return 0;
  v1 = file_ch4_ptr;
  do
  {
    j_sse_reset((int)v1);
    j_mxe_reset();
    j_open_dump_file();
    v2 = malloc(_bss_start->mic_bufsize);
    while ( j_pcm_get_state() == 1 || j_pcm_get_state() == 2 )
    {
      if ( pcm_read(_bss_start->pcm_device, _bss_start->mic_buf, _bss_start->mic_bufsize) )
      {
        _android_log_print(6, "sound_trigger_hal", "pcm read error");
        free(v2);
        j_close_dump_file();
        j_close_pcm_device();
        return 0;
      }
      if ( !_bss_start->dw2 )
      {
        v3 = (FILE *)file_ch1;
        if ( !file_ch1 )
          goto LABEL_19;
        dw0 = _bss_start->dw0;
        dw1 = (const void *)_bss_start->dw1;
        goto LABEL_18;
      }
      j_packet_to_planer((__int16 *)_bss_start->mic_buf, v2, _bss_start->mic_bufsize >> 1);
      if ( file_ch1 )
        fwrite((const void *)_bss_start->dw1, 1u, _bss_start->dw0, (FILE *)file_ch1);
      if ( file_ch2 )
        fwrite((const void *)(_bss_start->dw1 + _bss_start->dw0), 1u, _bss_start->dw0, (FILE *)file_ch2);
      if ( file_ch3 )
        fwrite((const void *)(_bss_start->dw1 + 2 * _bss_start->dw0), 1u, _bss_start->dw0, (FILE *)file_ch3);
      v3 = (FILE *)file_ch4;
      if ( file_ch4 )
      {
        dw0 = _bss_start->dw0;
        dw1 = (const void *)(_bss_start->dw1 + 3 * dw0);
LABEL_18:
        fwrite(dw1, 1u, dw0, v3);
      }
LABEL_19:
      j_sse_process((void *)_bss_start->dw1, _bss_start->dw2, (void *)_bss_start->dw4, _bss_start->dw0);
    }
    j_close_dump_file();
    _android_log_print(3, "sound_trigger_hal", "going to wait for pcm read state %d", _bss_start->state);
    j_close_pcm_device();
    free(v2);
    pthread_mutex_lock(&_bss_start->lock);
    v6 = _bss_start;
    p_state = &_bss_start->state;
    v8 = _bss_start->state;
    switch ( v8 )
    {
      case 0:
        goto LABEL_27;
      case 4:
        state = &_bss_start->state;
LABEL_26:
        *state = 0;
LABEL_27:
        pthread_cond_wait(&v6->cond, &v6->lock);
        v6 = _bss_start;
        break;
      case 3:
        state = &_bss_start->force_idle;
        if ( _bss_start->force_idle )
        {
          *p_state = 0;
          goto LABEL_26;
        }
        *p_state = 1;
        break;
    }
    pthread_mutex_unlock(&v6->lock);
    _android_log_print(3, "sound_trigger_hal", "wake up for pcm read, state %d", _bss_start->state);
    j_clear_buffer_state();
    if ( j_pcm_get_state() == 5 )
      break;
    j_open_pcm_device();
    v1 = (int **)j_pcm_get_state();
  }
  while ( v1 != (int **)&byte_5 );
  return 0;
}
// 5: using guessed type char byte_5;
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 7D60: using guessed type int __fastcall pcm_read(_DWORD, _DWORD, _DWORD);
// 9278: using guessed type int *file_ch4_ptr[5];
// F8C0: using guessed type int file_ch1;
// F8C4: using guessed type int file_ch2;
// F8C8: using guessed type int file_ch3;
// F8CC: using guessed type int file_ch4;

//----- (000053C8) --------------------------------------------------------
int __fastcall sound_trigger_hw_call_back(int a1, int *a2)
{
  int tx_concurrency_active; // r0
  bool v5; // zf
  int v6; // r0
  int rx_concurrency_active; // r0
  int v9; // r0
  int v10; // r1
  int v11; // r0
  int v12; // r0
  bool v13; // zf
  bool v15; // zf

  pthread_mutex_lock(&my_dev.lock);
  if ( a1 == 7 )
  {
    if ( a2 )
    {
      j_sva_read_pcm((char *)a2[1], a2[2]);
      _android_log_print(2, "sound_trigger_hal", "read sample  %zu", a2[2]);
    }
    else
    {
      _android_log_print(6, "sound_trigger_hal", "%s: Invalid config", "sound_trigger_hw_call_back");
    }
  }
  else
  {
    _android_log_print(
      3,
      "sound_trigger_hal",
      "%s  event %d rx_concurrency_active %d, tx_concurrency_active %d, screen on %d, music on %d",
      "sound_trigger_hw_call_back",
      a1,
      my_dev.rx_concurrency_active,
      my_dev.tx_concurrency_active,
      my_dev.screen_on,
      my_dev.music_on);
    switch ( a1 )
    {
      case 0:
        tx_concurrency_active = my_dev.tx_concurrency_active;
        if ( my_dev.tx_concurrency_active >= 1 )
          tx_concurrency_active = --my_dev.tx_concurrency_active;
        if ( !tx_concurrency_active && my_dev.recognition_config )
        {
          v5 = my_dev.music_on == 1;
          if ( my_dev.music_on != 1 )
            v5 = my_dev.screen_on == 1;
          if ( v5 )
            j_pcm_start_read();
        }
        break;
      case 1:
        v6 = my_dev.tx_concurrency_active++;
        if ( !v6 && my_dev.recognition_config )
          j_pcm_stop_read();
        break;
      case 2:
        rx_concurrency_active = my_dev.rx_concurrency_active;
        if ( my_dev.rx_concurrency_active >= 1 )
          rx_concurrency_active = --my_dev.rx_concurrency_active;
        if ( !rx_concurrency_active )
        {
          my_dev.music_on = 0;
          j_pcm_transfer_to_barge_in(0);
          if ( my_dev.screen_on == 1 )
          {
            if ( my_dev.recognition_config && !my_dev.tx_concurrency_active )
              goto LABEL_67;
          }
          else if ( !my_dev.screen_on && my_dev.recognition_config )
          {
            goto LABEL_41;
          }
        }
        break;
      case 3:
        if ( !my_dev.rx_concurrency_active++ )
        {
          my_dev.music_on = 1;
          j_pcm_transfer_to_barge_in(1);
          if ( !my_dev.tx_concurrency_active )
          {
            if ( my_dev.recognition_config )
            {
LABEL_67:
              v12 = 1;
              goto LABEL_68;
            }
          }
        }
        break;
      case 4:
        dereg_hal_event_session();
        j_exit_buffer_state();
        j_pcm_set_state(4);
        _android_log_print(3, "sound_trigger_hal", "stop lab");
        break;
      case 5:
        _android_log_print(3, "sound_trigger_hal", "get AUDIO_EVENT_SSR");
        if ( *a2 == 1 )
        {
          if ( my_dev.tx_concurrency_active || j_pcm_get_state() != 1 && j_pcm_get_state() != 3 )
            goto LABEL_32;
          v15 = my_dev.screen_on == 1;
          if ( my_dev.screen_on != 1 )
            v15 = my_dev.music_on == 1;
          if ( v15 )
            v9 = 1;
          else
LABEL_32:
            v9 = 0;
          j_pcm_handle_ssr(v9);
        }
        break;
      case 8:
        if ( a2 )
        {
          v10 = *a2;
          v11 = 1;
          goto LABEL_38;
        }
        _android_log_print(6, "sound_trigger_hal", "%s: NULL config for DEVICE_CONNECT", "sound_trigger_hw_call_back");
        break;
      case 9:
        if ( a2 )
        {
          v10 = *a2;
          v11 = 0;
LABEL_38:
          j_handle_device_switch(v11, v10);
        }
        else
        {
          _android_log_print(
            6,
            "sound_trigger_hal",
            "%s: NULL config for DEVICE_DISCONNECT",
            "sound_trigger_hw_call_back");
        }
        break;
      case 18:
        my_dev.screen_on = 0;
        if ( my_dev.recognition_config && !my_dev.music_on )
LABEL_41:
          j_pcm_pause_read();
        break;
      case 19:
        my_dev.screen_on = 1;
        if ( my_dev.recognition_config && !my_dev.tx_concurrency_active )
        {
          v12 = 0;
LABEL_68:
          j_pcm_resume_read(v12);
        }
        break;
      case 20:
        _android_log_print(3, "sound_trigger_hal", "get AUDIO_EVENT_MAP");
        if ( !my_dev.tx_concurrency_active && (j_pcm_get_state() == 1 || j_pcm_get_state() == 3) )
        {
          v13 = my_dev.screen_on == 1;
          if ( my_dev.screen_on != 1 )
            v13 = my_dev.music_on == 1;
          if ( v13 )
            j_pcm_handle_reset();
        }
        break;
      default:
        _android_log_print(4, "sound_trigger_hal", "event %d", a1);
        break;
    }
    _android_log_print(
      3,
      "sound_trigger_hal",
      "%s  rx_concurrency_active %d, tx_concurrency_active %d, screen on %d, music on %d",
      "sound_trigger_hw_call_back",
      my_dev.rx_concurrency_active,
      my_dev.tx_concurrency_active,
      my_dev.screen_on,
      my_dev.music_on);
  }
  pthread_mutex_unlock(&my_dev.lock);
  return 0;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (000056FC) --------------------------------------------------------
uint32_t hal_get_state()
{
  uint32_t dword_A5FC; // r5

  pthread_mutex_lock(&my_dev.lock);
  dword_A5FC = my_dev.dword_A5FC;
  pthread_mutex_unlock(&my_dev.lock);
  return dword_A5FC;
}

//----- (00005720) --------------------------------------------------------
int __fastcall hal_set_state(uint32_t a1)
{
  pthread_mutex_lock(&my_dev.lock);
  my_dev.dword_A5FC = a1;
  return _ThumbV7PILongThunk_pthread_mutex_unlock(&my_dev.lock);
}

//----- (00005744) --------------------------------------------------------
int wakeup_call_back()
{
  pthread_mutex_lock(&my_dev.lock);
  my_dev.dword_A5FC = 2;
  pthread_cond_signal(&my_dev.cond);
  return _ThumbV7PILongThunk_pthread_mutex_unlock(&my_dev.lock);
}

//----- (00005770) --------------------------------------------------------
int __fastcall stdev_close(const struct my_device *device)
{
  int v2; // r5

  _android_log_print(4, "sound_trigger_hal", "%s:", "stdev_close");
  if ( !device->dword_A5EC )
  {
    _android_log_print(6, "sound_trigger_hal", "%s: Device has beein already closed", "stdev_close");
LABEL_6:
    v2 = -14;
    goto LABEL_7;
  }
  j_sound_trigger_pcm_close();
  pthread_mutex_lock(&device->lock);
  if ( !device->dword_A5EC )
  {
    _android_log_print(6, "sound_trigger_hal", "%s: device already closed", "stdev_close");
    goto LABEL_6;
  }
  v2 = 0;
  device->dword_A5EC = 0;
  device->model_handle = 0;
  pthread_mutex_lock(&my_dev.lock);
  my_dev.dword_A5FC = 5;
  pthread_mutex_unlock(&my_dev.lock);
  pthread_cond_signal(&device->cond);
  pthread_join(device->thread, 0);
LABEL_7:
  pthread_mutex_unlock(&device->lock);
  return v2;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 7E80: using guessed type int j_sound_trigger_pcm_close(void);

//----- (00005828) --------------------------------------------------------
int __fastcall stdev_open(struct hw_module *module, const char *name, struct hw_device *device)
{
  int v6; // r7
  void *v7; // r0

  _android_log_print(4, "sound_trigger_hal", "%s:", "stdev_open");
  if ( !strcmp(name, "sound_trigger_hw_if") )
  {
    pthread_mutex_lock(&my_dev.lock);
    if ( my_dev.dword_A5EC )
    {
      _android_log_print(6, "sound_trigger_hal", "%s: Only one sountrigger can be opened at a time", "stdev_open");
      v6 = -16;
LABEL_11:
      pthread_mutex_unlock(&my_dev.lock);
      _android_log_print(4, "sound_trigger_hal", "%s: Exit", "stdev_open");
      return v6;
    }
    v7 = dlopen("/vendor/lib/hw/audio.primary.sdm710.so", 0);
    my_dev.audio_hal = v7;
    if ( v7 )
    {
      my_dev.audio_hw_callback = (int (__fastcall *)(int, void *))dlsym(v7, "audio_hw_call_back");
      if ( my_dev.audio_hw_callback )
      {
        v6 = 0;
        my_dev.dword_A5FC = 0;
        my_dev.dword_A5EC = 1;
        my_dev.st_dev.common.tag = 0x48574454;
        my_dev.st_dev.common.version = 257;
        my_dev.st_dev.common.module = module;
        my_dev.model_handle = 0;
        my_dev.music_on = 0;
        my_dev.screen_on = 1;
        my_dev.recognition_config = 0;
        my_dev.st_dev.common.close = stdev_close;
        my_dev.st_dev.get_properties = stdev_get_properties;
        my_dev.st_dev.load_sound_model = (int (__fastcall *)(const struct sound_trigger_hw_device *, struct sound_trigger_sound_model *, sound_model_callback_t, void *, sound_model_handle_t *))stdev_load_sound_model;
        my_dev.st_dev.unload_sound_model = (int (__fastcall *)(const struct sound_trigger_hw_device *, sound_model_handle_t))stdev_unload_sound_model;
        my_dev.st_dev.start_recognition = (int (__fastcall *)(const struct sound_trigger_hw_device *, sound_model_handle_t, const struct sound_trigger_recognition_config *, recognition_callback_t, void *))stdev_start_recognition;
        my_dev.st_dev.stop_recognition = (int (__fastcall *)(const struct sound_trigger_hw_device *, sound_model_handle_t))stdev_stop_recognition;
        device->tag = (uint32_t)&my_dev;
        pthread_create(&my_dev.thread, 0, (void *(*)(void *))callback_thread_loop, &my_dev);
        j_sound_trigger_pcm_open(0);
        goto LABEL_11;
      }
      _android_log_print(6, "sound_trigger_hal", "%s: ERROR. dlsym Error sound_trigger_hw_call_back", "load_audio_hal");
    }
    else
    {
      _android_log_print(6, "sound_trigger_hal", "%s: ERROR", "load_audio_hal");
    }
    v6 = -19;
    goto LABEL_11;
  }
  return -22;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (000059C0) --------------------------------------------------------
int __fastcall stdev_get_properties(
        const struct sound_trigger_hw_device *dev,
        struct sound_trigger_properties *properties)
{
  _android_log_print(2, "sound_trigger_hal", "%s , %p", "stdev_get_properties", dev);
  if ( !properties )
    return -22;
  qmemcpy(properties, &hw_properties, sizeof(struct sound_trigger_properties));
  return 0;
}
// 3268: using guessed type sound_trigger_properties hw_properties;
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (00005A04) --------------------------------------------------------
int __fastcall stdev_load_sound_model(
        const struct my_device *dev,
        struct sound_trigger_sound_model *sound_model,
        sound_model_callback_t callback,
        void *cookie,
        sound_model_handle_t *handle)
{
  unsigned int data_size; // r0
  int v10; // r7
  int type; // r3

  _android_log_print(2, "sound_trigger_hal", "%s", "stdev_load_sound_model");
  pthread_mutex_lock(&dev->lock);
  if ( !sound_model || !handle )
  {
    _android_log_print(6, "sound_trigger_hal", "%s handle or sound_model is NULL", "stdev_load_sound_model");
    goto LABEL_8;
  }
  data_size = sound_model->data_size;
  if ( !data_size || sound_model->data_offset < 0x2C )
    goto LABEL_8;
  if ( dev->model_handle == 1 )
  {
    _android_log_print(6, "sound_trigger_hal", "%s stdev->model_handle == 1", "stdev_load_sound_model");
    v10 = -38;
    goto LABEL_9;
  }
  _android_log_print(
    2,
    "sound_trigger_hal",
    "%s sound_model->data_offset=%d, sound_model->data_size=%d",
    "stdev_load_sound_model",
    sound_model->data_offset,
    data_size);
  if ( !memcmp(&sound_model->vendor_uuid, &hw_properties.uuid, 0x10u) )
  {
    _android_log_print(
      2,
      "sound_trigger_hal",
      "%s: no valid vendor_uuid present, consider as error",
      "stdev_load_sound_model");
    goto LABEL_8;
  }
  if ( sound_model->type )
  {
    if ( sound_model->type == 1 )
    {
      _android_log_print(4, "sound_trigger_hal", "load generic sound model");
      goto LABEL_16;
    }
    _android_log_print(4, "sound_trigger_hal", "unknow sound model");
LABEL_8:
    v10 = -22;
    goto LABEL_9;
  }
  _android_log_print(4, "sound_trigger_hal", "load keyphrase sound model");
LABEL_16:
  v10 = j_mxe_load_sound_model((int)sound_model + sound_model->data_offset, sound_model->data_size);
  if ( !v10 )
  {
    dev->model_callback = callback;
    dev->model_cookie = cookie;
    dev->model_handle = 1;
    type = sound_model->type;
    dev[1].st_dev.common.tag = sound_model->type;
    _android_log_print(4, "sound_trigger_hal", "sound model type is %d", type);
    v10 = 0;
    *handle = dev->model_handle;
  }
LABEL_9:
  pthread_mutex_unlock(&dev->lock);
  return v10;
}
// 3268: using guessed type sound_trigger_properties hw_properties;
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (00005B7C) --------------------------------------------------------
int __fastcall stdev_unload_sound_model(const struct my_device *dev, sound_model_handle_t handle)
{
  void *recognition_config; // r0
  int v5; // r6

  _android_log_print(2, "sound_trigger_hal", "%s handle %d", "stdev_unload_sound_model", handle);
  pthread_mutex_lock(&dev->lock);
  if ( handle == 1 )
  {
    if ( dev->model_handle )
    {
      j_pcm_stop_read();
      recognition_config = dev->recognition_config;
      v5 = 0;
      dev->model_handle = 0;
      free(recognition_config);
      dev->recognition_config = 0;
      _android_log_print(2, "sound_trigger_hal", "%s handle %d exit", "stdev_unload_sound_model", 1);
    }
    else
    {
      v5 = -38;
    }
  }
  else
  {
    v5 = -22;
  }
  pthread_mutex_unlock(&dev->lock);
  return v5;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 7E10: using guessed type int j_pcm_stop_read(void);

//----- (00005C04) --------------------------------------------------------
int __fastcall stdev_start_recognition(
        const struct my_device *dev,
        sound_model_handle_t handle,
        const struct sound_trigger_recognition_config *config,
        recognition_callback_t callback,
        void *cookie)
{
  pthread_mutex_t *p_lock; // r11
  const struct sound_trigger_recognition_config *v10; // r0
  int screen_on; // r0
  bool v12; // zf
  int v13; // r5
  struct sound_trigger_event_info v15; // [sp+10h] [bp-60h] BYREF

  _android_log_print(
    3,
    "sound_trigger_hal",
    "%s sound model %d, tx_concurrency_active %d, screen on %d, music on %d",
    "stdev_start_recognition",
    handle,
    dev->tx_concurrency_active,
    dev->screen_on,
    dev->music_on);
  p_lock = &dev->lock;
  pthread_mutex_lock(&dev->lock);
  if ( dev->model_handle == handle )
  {
    free(dev->recognition_config);
    dev->recognition_config = 0;
    if ( config )
    {
      v10 = (const struct sound_trigger_recognition_config *)malloc(0x3D8u);
      dev->recognition_config = v10;
      if ( !v10 )
      {
        v13 = -12;
        goto LABEL_16;
      }
      qmemcpy(v10, config, 0x3D8u);
    }
    dev->recongnition_callback = callback;
    dev->recongnition_cookie = cookie;
    dev->capture_handle = *(_DWORD *)config;
    dev->capture_requested = *((_BYTE *)config + 8);
    _android_log_print(3, "sound_trigger_hal", "start recognition");
    if ( !dev->tx_concurrency_active )
    {
      screen_on = dev->screen_on;
      v12 = screen_on == 1;
      if ( screen_on != 1 )
        v12 = dev->music_on == 1;
      if ( v12 )
        j_pcm_start_read();
    }
    memset(&v15, 0, sizeof(v15));
    if ( my_dev.capture_requested && my_dev.audio_hw_callback )
    {
      _android_log_print(
        3,
        "sound_trigger_hal",
        "%s: ST_EVENT_SESSION_REGISTER capture_handle %d  ",
        "reg_hal_event_session",
        my_dev.capture_handle);
      v15.st_ses.p_ses = 0;
      v15.st_ses.config = pcm_config_hotword;
      v15.st_ses.capture_handle = my_dev.capture_handle;
      my_dev.audio_hw_callback(0, &v15);
    }
    v13 = 0;
  }
  else
  {
    v13 = -38;
  }
LABEL_16:
  _android_log_print(3, "sound_trigger_hal", " stdev_start_recognition exit");
  pthread_mutex_unlock(p_lock);
  return v13;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 7E00: using guessed type int j_pcm_start_read(void);

//----- (00005D98) --------------------------------------------------------
int __fastcall stdev_stop_recognition(const struct my_device *dev, sound_model_handle_t handle)
{
  int v4; // r0
  int v5; // r6

  _android_log_print(
    3,
    "sound_trigger_hal",
    "%s sound model %d, tx_concurrency_active %d, screen on %d, music on %d",
    "stdev_stop_recognition",
    handle,
    dev->tx_concurrency_active,
    dev->screen_on,
    dev->music_on);
  if ( dev->model_handle == handle )
  {
    v4 = j_pcm_stop_read();
    dereg_hal_event_session(v4);
    pthread_mutex_lock(&dev->lock);
    free(dev->recognition_config);
    v5 = 0;
    dev->recognition_config = 0;
    _android_log_print(3, "sound_trigger_hal", "%s sound model exit%d", "stdev_stop_recognition", handle);
  }
  else
  {
    v5 = -38;
  }
  pthread_mutex_unlock(&dev->lock);
  return v5;
}
// 60BC: using guessed type int __fastcall dereg_hal_event_session(_DWORD);
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 7E10: using guessed type int j_pcm_stop_read(void);

//----- (00005E28) --------------------------------------------------------
int __fastcall callback_thread_loop(sound_trigger_hw_device *st_device)
{
  struct my_device *v2; // r7
  uint32_t dword_A5FC; // r4
  int v4; // r8
  pthread_cond_t *v5; // r9
  int v6; // r4
  int (__fastcall *start_recognition)(const struct sound_trigger_hw_device *, sound_model_handle_t, const struct sound_trigger_recognition_config *, recognition_callback_t, void *); // r0
  struct my_device *v8; // r9
  uint32_t v9; // r7
  int (__fastcall *unload_sound_model)(const struct sound_trigger_hw_device *, sound_model_handle_t); // r4
  char *v11; // r0
  char *v12; // r5
  unsigned int v13; // r0
  char *v14; // r7
  char *v15; // r4
  unsigned int v16; // r8
  uint32_t v17; // r0
  uint32_t tag; // r4
  char *v19; // r0
  uint32_t v20; // r0
  int v21; // r4

  v2 = &my_dev;
  pthread_mutex_lock(&my_dev.lock);
  dword_A5FC = my_dev.dword_A5FC;
  pthread_mutex_unlock(&my_dev.lock);
  v4 = 0;
  if ( dword_A5FC != 5 )
  {
    v5 = (pthread_cond_t *)&st_device[1].common.reserved[9];
    while ( 1 )
    {
      pthread_mutex_lock(&my_dev.lock);
      v6 = *(int *)((char *)&dword_A4 + (_DWORD)v2);
      pthread_mutex_unlock(&my_dev.lock);
      if ( v6 == 2 )
        break;
      _android_log_print(6, "sound_trigger_hal", "going to wait");
      pthread_mutex_lock((pthread_mutex_t *)&st_device[1].common.reserved[8]);
      pthread_cond_wait(v5, (pthread_mutex_t *)&st_device[1].common.reserved[8]);
      pthread_mutex_unlock((pthread_mutex_t *)&st_device[1].common.reserved[8]);
      _android_log_print(6, "sound_trigger_hal", "wake up ");
LABEL_19:
      pthread_mutex_lock(&my_dev.lock);
      v21 = *(int *)((char *)&dword_A4 + (_DWORD)v2);
      pthread_mutex_unlock(&my_dev.lock);
      if ( v21 == 5 )
        return 0;
    }
    start_recognition = st_device[1].start_recognition;
    if ( start_recognition == (int (__fastcall *)(const struct sound_trigger_hw_device *, sound_model_handle_t, const struct sound_trigger_recognition_config *, recognition_callback_t, void *))((char *)&dword_0 + 1) )
    {
      tag = st_device[1].common.tag;
      _android_log_print(2, "sound_trigger_hal", "%s:", "sound_trigger_generic_event_alloc");
      v19 = (char *)calloc(1u, 0x80u);
      if ( !v19 )
      {
LABEL_21:
        _android_log_print(
          6,
          "sound_trigger_hal",
          "%s: Error allocating an event for a model: %d",
          "callback_thread_loop",
          st_device[1].common.tag);
        return -12;
      }
      v19[12] = 1;
      v12 = v19;
      *((_DWORD *)v19 + 1) = 1;
      *((_DWORD *)v19 + 2) = tag;
      qmemcpy(v19 + 32, &unk_3320, 0x58u);
      v20 = st_device[1].common.tag;
      *((_DWORD *)v12 + 8) = 16000;
      *((_DWORD *)v12 + 9) = 16;
      *((_DWORD *)v12 + 10) = 1;
      _android_log_print(
        4,
        "sound_trigger_hal",
        "%s: Send Callback for a Generic model %d",
        "callback_thread_loop",
        v20);
      ((void (__fastcall *)(char *, struct hw_module *))st_device[1].common.version)(v12, st_device[1].common.module);
    }
    else
    {
      if ( start_recognition )
      {
LABEL_18:
        pthread_mutex_lock(&my_dev.lock);
        *(int *)((char *)&dword_A4 + (_DWORD)v2) = 0;
        pthread_mutex_unlock(&my_dev.lock);
        goto LABEL_19;
      }
      v8 = v2;
      v9 = st_device[1].common.tag;
      unload_sound_model = st_device[1].unload_sound_model;
      _android_log_print(2, "sound_trigger_hal", "%s:", "sound_trigger_keyphrase_event_alloc");
      v11 = (char *)calloc(1u, 0x448u);
      if ( !v11 )
        goto LABEL_21;
      v12 = v11;
      *((_DWORD *)v11 + 2) = v9;
      if ( unload_sound_model )
      {
        v13 = *((_DWORD *)unload_sound_model + 3);
        if ( v13 >= 0xA )
          v13 = 10;
        *((_DWORD *)v12 + 32) = v13;
        if ( v13 )
        {
          v14 = (char *)unload_sound_model + 16;
          v15 = v12 + 132;
          v16 = 0;
          do
          {
            qmemcpy(v15, v14, 0x60u);
            ++v16;
            v14 += 96;
            v15 += 96;
          }
          while ( v16 < *((_DWORD *)v12 + 32) );
        }
      }
      *(_QWORD *)(v12 + 140) = 0x100000064LL;
      *(_QWORD *)(v12 + 148) = 0x6400000000LL;
      *((_DWORD *)v12 + 32) = 1;
      v12[12] = 1;
      qmemcpy(v12 + 32, &unk_3320, 0x58u);
      v17 = st_device[1].common.tag;
      *((_DWORD *)v12 + 8) = 16000;
      *((_DWORD *)v12 + 34) = 1;
      *((_DWORD *)v12 + 9) = 16;
      *((_DWORD *)v12 + 10) = 1;
      _android_log_print(4, "sound_trigger_hal", "%s Send callback model %d", "callback_thread_loop", v17);
      ((void (__fastcall *)(char *, struct hw_module *))st_device[1].common.version)(v12, st_device[1].common.module);
      v2 = v8;
      v5 = (pthread_cond_t *)&st_device[1].common.reserved[9];
    }
    free(v12);
    goto LABEL_18;
  }
  return v4;
}
// 0: using guessed type int dword_0;
// A4: using guessed type int dword_A4;
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (000060BC) --------------------------------------------------------
int dereg_hal_event_session()
{
  _DWORD v1[20]; // [sp+8h] [bp-50h] BYREF

  memset(v1, 0, 56);
  if ( my_dev.capture_requested && my_dev.audio_hw_callback )
  {
    _android_log_print(
      3,
      "sound_trigger_hal",
      "%s: ST_EVENT_SESSION_DEREGISTER capture_handle %d",
      "dereg_hal_event_session",
      my_dev.capture_handle);
    v1[0] = 0;
    v1[1] = my_dev.capture_handle;
    my_dev.audio_hw_callback(1, v1);
  }
  return _stack_chk_guard - v1[15];
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (0000614C) --------------------------------------------------------
int __fastcall sse_reset(int a1)
{
  int inited; // r0

  inited = j_init_wr_rt_ptr(a1);
  return _ThumbV7PILongThunk_init_wr_rt_ptr1(inited);
}

//----- (0000615A) --------------------------------------------------------
int sse_get_ref_channel()
{
  return 0;
}

//----- (0000615E) --------------------------------------------------------
int sse_get_mic_channel()
{
  return 1;
}

//----- (00006162) --------------------------------------------------------
int sse_get_frame_size()
{
  return 320;
}

//----- (00006168) --------------------------------------------------------
int sse_init()
{
  uint32_t *v0; // r4
  void *v1; // r0
  int v2; // r0
  uint32_t *v3; // r4
  void *v4; // r0
  pthread_mutex_t *v5; // r0
  int v6; // r4
  int v7; // r0

  v0 = (uint32_t *)malloc(0x34u);
  ssedev = (int)v0;
  if ( !v0 )
    goto LABEL_6;
  v0[3] = 128000;
  v1 = malloc(0x1F400u);
  v0[2] = (uint32_t)v1;
  if ( !v1 )
  {
LABEL_7:
    _android_log_print(6, "sound_trigger_hal", "sse pcm_out_buf malloc fail ");
    return -1;
  }
  pthread_mutex_init((pthread_mutex_t *)v0 + 12, 0);
  v2 = pthread_cond_init((pthread_cond_t *)(ssedev + 44), 0);
  j_init_wr_rt_ptr(v2);
  v3 = (uint32_t *)malloc(0x34u);
  ssedev1 = (int)v3;
  if ( !v3 )
  {
LABEL_6:
    _android_log_print(6, "sound_trigger_hal", "sse device malloc fail");
    return -1;
  }
  v3[3] = 128000;
  v4 = malloc(0x1F400u);
  v3[1] = (uint32_t)v4;
  if ( !v4 )
    goto LABEL_7;
  v5 = (pthread_mutex_t *)(v3 + 12);
  v6 = 0;
  pthread_mutex_init(v5, 0);
  v7 = pthread_cond_init((pthread_cond_t *)(ssedev1 + 44), 0);
  j_init_wr_rt_ptr1(v7);
  return v6;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// FBB4: using guessed type int ssedev;
// FBB8: using guessed type int ssedev1;

//----- (00006220) --------------------------------------------------------
int sse_deinit()
{
  void *v0; // r0
  void *v1; // r0

  v0 = (void *)ssedev;
  if ( *(_DWORD *)(ssedev + 8) )
  {
    free(*(void **)(ssedev + 8));
    v0 = (void *)ssedev;
  }
  if ( v0 )
    free(v0);
  v1 = (void *)ssedev1;
  if ( *(_DWORD *)(ssedev1 + 4) )
  {
    free(*(void **)(ssedev1 + 4));
    v1 = (void *)ssedev1;
  }
  if ( v1 )
    free(v1);
  return 0;
}
// FBB4: using guessed type int ssedev;
// FBB8: using guessed type int ssedev1;

//----- (00006264) --------------------------------------------------------
_WORD *__fastcall stereo_to_mono(_WORD *result, _WORD *a2, _WORD *a3, unsigned int a4)
{
  unsigned int v4; // r12
  int v5; // lr
  __int16 v6; // r3

  if ( a4 >> 2 )
  {
    v4 = a4 >> 2;
    v5 = 0;
    do
    {
      ++v5;
      *a2++ = *result;
      v6 = result[1];
      result += 2;
      *a3++ = v6;
    }
    while ( v5 != v4 );
  }
  return result;
}

//----- (00006294) --------------------------------------------------------
int __fastcall save_pcm_data1(char *a1, size_t a2)
{
  int i; // r0
  size_t v5; // r6
  __int64 v6; // kr00_8
  size_t v7; // r7
  size_t v8; // r1
  int v9; // r2
  size_t v10; // r3
  size_t v11; // r2

  pthread_mutex_lock((pthread_mutex_t *)(ssedev1 + 48));
  for ( i = ssedev1; a2; *(_DWORD *)(i + 16) = v8 )
  {
    v5 = *(_DWORD *)(i + 12);
    v6 = *(_QWORD *)(i + 24);
    if ( a2 < v5 )
      v5 = a2;
    if ( (unsigned int)v6 >= HIDWORD(v6) + v5 )
    {
      qmemcpy((void *)HIDWORD(v6), a1, v5);
      i = ssedev1;
      v9 = *(_DWORD *)(ssedev1 + 16);
      v8 = *(_DWORD *)(ssedev1 + 12);
      v10 = *(_DWORD *)(ssedev1 + 28) + v5;
    }
    else
    {
      qmemcpy((void *)HIDWORD(v6), a1, v6 - HIDWORD(v6));
      v7 = v5 - (v6 - HIDWORD(v6));
      qmemcpy(*(void **)(ssedev1 + 32), &a1[v6 - HIDWORD(v6)], v7);
      i = ssedev1;
      v9 = *(_DWORD *)(ssedev1 + 16);
      v8 = *(_DWORD *)(ssedev1 + 12);
      v10 = *(_DWORD *)(ssedev1 + 32) + v7;
    }
    v11 = v9 + v5;
    *(_DWORD *)(i + 28) = v10;
    if ( v11 < v8 )
      v8 = v11;
    a1 += v5;
    a2 -= v5;
  }
  pthread_mutex_unlock((pthread_mutex_t *)(i + 48));
  return 0;
}
// FBB8: using guessed type int ssedev1;

//----- (00006324) --------------------------------------------------------
int __fastcall sse_write_pcm_data1(char *a1, size_t a2)
{
  int v4; // r0
  int v5; // r6
  __int64 v6; // kr00_8
  size_t v7; // r7
  __int64 v8; // kr08_8
  size_t v9; // r6
  pthread_cond_t *v10; // r0
  size_t v11; // r1

  pthread_mutex_lock((pthread_mutex_t *)(ssedev1 + 48));
  v4 = ssedev1;
  v5 = 0;
  if ( a2 && !*(_DWORD *)(ssedev1 + 8) )
  {
    while ( 1 )
    {
      v6 = *(_QWORD *)(v4 + 12);
      v7 = v6 - HIDWORD(v6);
      if ( (_DWORD)v6 == HIDWORD(v6) )
      {
        _android_log_print(3, "sound_trigger_hal", "%s: waiting on cond, bytes=%d", "sse_write_pcm_data1", a2);
        pthread_cond_wait((pthread_cond_t *)(ssedev1 + 44), (pthread_mutex_t *)(ssedev1 + 48));
        v4 = ssedev1;
        if ( *(_DWORD *)(ssedev1 + 8) )
          break;
      }
      v8 = *(_QWORD *)(v4 + 24);
      if ( a2 < v7 )
        v7 = a2;
      if ( (unsigned int)v8 >= HIDWORD(v8) + v7 )
      {
        qmemcpy((void *)HIDWORD(v8), a1, v7);
        v10 = (pthread_cond_t *)ssedev1;
        v11 = *(_DWORD *)(ssedev1 + 28) + v7;
      }
      else
      {
        qmemcpy((void *)HIDWORD(v8), a1, v8 - HIDWORD(v8));
        v9 = v7 - (v8 - HIDWORD(v8));
        qmemcpy(*(void **)(ssedev1 + 32), &a1[v8 - HIDWORD(v8)], v9);
        v10 = (pthread_cond_t *)ssedev1;
        v11 = *(_DWORD *)(ssedev1 + 32) + v9;
      }
      v10[7].__private[0] = v11;
      v10[4].__private[0] += v7;
      pthread_cond_signal(v10 + 11);
      v4 = ssedev1;
      a2 -= v7;
      v5 = 0;
      if ( a2 )
      {
        a1 += v7;
        if ( !*(_DWORD *)(ssedev1 + 8) )
          continue;
      }
      goto LABEL_15;
    }
    _android_log_print(
      3,
      "sound_trigger_hal",
      "%s: buffering stopped while waiting on cond, exiting",
      "sse_write_pcm_data1");
    v4 = ssedev1;
    v5 = -5;
  }
LABEL_15:
  pthread_mutex_unlock((pthread_mutex_t *)(v4 + 48));
  return v5;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// FBB8: using guessed type int ssedev1;

//----- (0000643C) --------------------------------------------------------
int __fastcall sse_read_pcm_data1(char *a1, size_t a2)
{
  int v4; // r6
  int v5; // r0
  size_t v6; // r7
  int v7; // r0
  __int64 v8; // kr00_8
  size_t v9; // r6
  size_t v10; // r1
  int v11; // r1
  struct timespec tp; // [sp+8h] [bp-30h] BYREF

  v4 = 0;
  tp.tv_sec = 0;
  tp.tv_nsec = 0;
  pthread_mutex_lock((pthread_mutex_t *)(ssedev1 + 48));
  v5 = ssedev1;
  if ( a2 && !*(_DWORD *)(ssedev1 + 8) )
  {
    while ( 1 )
    {
      v6 = *(_DWORD *)(v5 + 16);
      if ( !v6 )
      {
        clock_gettime(0, &tp);
        tp.tv_sec += 2;
        v7 = pthread_cond_timedwait((pthread_cond_t *)(ssedev1 + 44), (pthread_mutex_t *)(ssedev1 + 48), &tp);
        if ( v7 )
        {
          _android_log_print(6, "sound_trigger_hal", "%s: ERROR. read wait timed out, ret %d", "sse_read_pcm_data1", v7);
          v5 = ssedev1;
          v4 = -5;
          *(_DWORD *)(ssedev1 + 8) = 1;
          break;
        }
        v5 = ssedev1;
        if ( *(_DWORD *)(ssedev1 + 8) )
        {
          _android_log_print(
            3,
            "sound_trigger_hal",
            "%s: buffering stopped while waiting on cond, exiting",
            "sse_read_pcm_data1");
          v5 = ssedev1;
          v4 = -5;
          break;
        }
        v6 = *(_DWORD *)(ssedev1 + 16);
      }
      v8 = *(_QWORD *)(v5 + 20);
      if ( a2 < v6 )
        v6 = a2;
      if ( HIDWORD(v8) >= (unsigned int)v8 + v6 )
      {
        qmemcpy(a1, (const void *)v8, v6);
        v5 = ssedev1;
        v10 = *(_DWORD *)(ssedev1 + 20) + v6;
      }
      else
      {
        qmemcpy(a1, (const void *)v8, HIDWORD(v8) - v8);
        v9 = v6 - (HIDWORD(v8) - v8);
        qmemcpy(&a1[HIDWORD(v8) - v8], *(const void **)(ssedev1 + 32), v9);
        v5 = ssedev1;
        v10 = *(_DWORD *)(ssedev1 + 32) + v9;
      }
      *(_DWORD *)(v5 + 20) = v10;
      a2 -= v6;
      v11 = *(_DWORD *)(v5 + 8);
      v4 = 0;
      *(_DWORD *)(v5 + 16) -= v6;
      if ( a2 )
      {
        a1 += v6;
        if ( !v11 )
          continue;
      }
      break;
    }
  }
  pthread_mutex_unlock((pthread_mutex_t *)(v5 + 48));
  return v4;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// FBB8: using guessed type int ssedev1;

//----- (0000658C) --------------------------------------------------------
int __fastcall update_wr_rt_ptr1(int a1, int a2)
{
  pthread_mutex_t *v4; // r0
  unsigned int v5; // r1
  unsigned int v6; // r3
  unsigned int v7; // r6
  unsigned int v8; // r12
  unsigned int v9; // r5
  unsigned int v10; // r5
  unsigned int v11; // r4
  unsigned int v12; // r1
  int v13; // r2
  int v14; // r6
  int v15; // r4
  int v16; // r2

  _android_log_print(4, "sound_trigger_hal", " %s", "update_wr_rt_ptr1");
  pthread_mutex_lock((pthread_mutex_t *)(ssedev1 + 48));
  v4 = (pthread_mutex_t *)ssedev1;
  v6 = *(_DWORD *)(ssedev1 + 32);
  v5 = *(_DWORD *)(ssedev1 + 28);
  v7 = v6 + a2;
  v8 = *(_DWORD *)(ssedev1 + 12);
  v9 = v5 - a2;
  if ( v7 > v5 )
    v9 = v5 + v8 - a1;
  if ( v6 + a1 > v9 )
    v9 += v8;
  v10 = v9 - a1;
  v11 = v10 - v6;
  if ( (int)(v10 - v6) < 9600 )
  {
    if ( *(_DWORD *)(ssedev1 + 16) >= v8 )
    {
      v16 = *(_DWORD *)(ssedev1 + 24) + v11 - 9600;
      *(_DWORD *)(ssedev1 + 16) = v5 + v8 - v16;
      v4[5].__private[0] = v16;
      goto LABEL_15;
    }
    v12 = v5 - v6;
    v13 = (unsigned __int64)(1717986919LL * (int)v11) >> 32;
  }
  else
  {
    v6 = v10 - 9600;
    if ( v5 > v10 )
    {
      *(_DWORD *)(ssedev1 + 16) = v5 - v6;
      v4[5].__private[0] = v6;
LABEL_15:
      v15 = 300;
      goto LABEL_16;
    }
    LOWORD(v14) = 26215;
    if ( v6 < v5 )
      v6 = *(_DWORD *)(ssedev1 + 28);
    HIWORD(v14) = 26214;
    v13 = (unsigned __int64)((int)(v10 - v6) * (__int64)v14) >> 32;
    v12 = v5 + v8 - v6;
  }
  *(_DWORD *)(ssedev1 + 16) = v12;
  v4[5].__private[0] = v6;
  v15 = 10 * ((v13 >> 7) + ((unsigned int)v13 >> 31));
LABEL_16:
  pthread_mutex_unlock(v4 + 12);
  return v15;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// FBB8: using guessed type int ssedev1;

//----- (00006660) --------------------------------------------------------
int init_wr_rt_ptr1()
{
  _DWORD *v0; // r0
  int v1; // r1
  int v2; // r2
  pthread_mutex_t *v3; // r3

  pthread_mutex_lock((pthread_mutex_t *)(ssedev1 + 48));
  v0 = (_DWORD *)ssedev1;
  v1 = *(_DWORD *)(ssedev1 + 4);
  v2 = *(_DWORD *)(ssedev1 + 12);
  *(_DWORD *)ssedev1 = 0;
  v0[4] = 0;
  v0[7] = v1;
  v0[8] = v1;
  v3 = (pthread_mutex_t *)ssedev1;
  v0[5] = v1;
  v0[6] = v2 + v1;
  return _ThumbV7PILongThunk_pthread_mutex_unlock(v3 + 12);
}
// FBB8: using guessed type int ssedev1;

//----- (00006698) --------------------------------------------------------
int __fastcall save_pcm_data(char *a1, size_t a2)
{
  int i; // r0
  size_t v5; // r6
  __int64 v6; // kr00_8
  size_t v7; // r7
  size_t v8; // r1
  int v9; // r2
  size_t v10; // r3
  size_t v11; // r2

  pthread_mutex_lock((pthread_mutex_t *)(ssedev + 48));
  for ( i = ssedev; a2; *(_DWORD *)(i + 16) = v8 )
  {
    v5 = *(_DWORD *)(i + 12);
    v6 = *(_QWORD *)(i + 24);
    if ( a2 < v5 )
      v5 = a2;
    if ( (unsigned int)v6 >= HIDWORD(v6) + v5 )
    {
      qmemcpy((void *)HIDWORD(v6), a1, v5);
      i = ssedev;
      v9 = *(_DWORD *)(ssedev + 16);
      v8 = *(_DWORD *)(ssedev + 12);
      v10 = *(_DWORD *)(ssedev + 28) + v5;
    }
    else
    {
      qmemcpy((void *)HIDWORD(v6), a1, v6 - HIDWORD(v6));
      v7 = v5 - (v6 - HIDWORD(v6));
      qmemcpy(*(void **)(ssedev + 32), &a1[v6 - HIDWORD(v6)], v7);
      i = ssedev;
      v9 = *(_DWORD *)(ssedev + 16);
      v8 = *(_DWORD *)(ssedev + 12);
      v10 = *(_DWORD *)(ssedev + 32) + v7;
    }
    v11 = v9 + v5;
    *(_DWORD *)(i + 28) = v10;
    if ( v11 < v8 )
      v8 = v11;
    a1 += v5;
    a2 -= v5;
  }
  pthread_mutex_unlock((pthread_mutex_t *)(i + 48));
  return 0;
}
// FBB4: using guessed type int ssedev;

//----- (00006728) --------------------------------------------------------
int exit_buffer_state()
{
  pthread_cond_t *v0; // r0
  int v1; // r1

  _android_log_print(3, "sound_trigger_hal", "%s ", "exit_buffer_state");
  pthread_mutex_lock((pthread_mutex_t *)(ssedev + 48));
  v0 = (pthread_cond_t *)ssedev;
  v1 = ssedev1;
  *(_DWORD *)(ssedev + 4) = 1;
  *(_DWORD *)(v1 + 8) = 1;
  pthread_cond_signal(v0 + 11);
  pthread_cond_signal((pthread_cond_t *)(ssedev1 + 44));
  pthread_mutex_unlock((pthread_mutex_t *)(ssedev + 48));
  _android_log_print(3, "sound_trigger_hal", "%s exit", "exit_buffer_state");
  return 0;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// FBB4: using guessed type int ssedev;
// FBB8: using guessed type int ssedev1;

//----- (000067A4) --------------------------------------------------------
int clear_buffer_state()
{
  pthread_mutex_t *v0; // r1

  _android_log_print(3, "sound_trigger_hal", "%s ", "clear_buffer_state");
  pthread_mutex_lock((pthread_mutex_t *)(ssedev + 48));
  v0 = (pthread_mutex_t *)ssedev;
  *(_DWORD *)(ssedev + 4) = 0;
  *(_DWORD *)(ssedev1 + 8) = 0;
  pthread_mutex_unlock(v0 + 12);
  _android_log_print(3, "sound_trigger_hal", "%s  exit", "clear_buffer_state");
  return 0;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// FBB4: using guessed type int ssedev;
// FBB8: using guessed type int ssedev1;

//----- (0000680C) --------------------------------------------------------
int __fastcall sse_write_pcm_data(char *a1, size_t a2)
{
  int v4; // r0
  int v5; // r6
  __int64 v6; // kr00_8
  size_t v7; // r7
  __int64 v8; // kr08_8
  size_t v9; // r6
  pthread_cond_t *v10; // r0
  size_t v11; // r1

  pthread_mutex_lock((pthread_mutex_t *)(ssedev + 48));
  v4 = ssedev;
  v5 = 0;
  if ( a2 && !*(_DWORD *)(ssedev + 4) )
  {
    while ( 1 )
    {
      v6 = *(_QWORD *)(v4 + 12);
      v7 = v6 - HIDWORD(v6);
      if ( (_DWORD)v6 == HIDWORD(v6) )
      {
        _android_log_print(3, "sound_trigger_hal", "%s: waiting on cond, bytes=%d", "sse_write_pcm_data", a2);
        pthread_cond_wait((pthread_cond_t *)(ssedev + 44), (pthread_mutex_t *)(ssedev + 48));
        v4 = ssedev;
        if ( *(_DWORD *)(ssedev + 4) )
          break;
      }
      v8 = *(_QWORD *)(v4 + 24);
      if ( a2 < v7 )
        v7 = a2;
      if ( (unsigned int)v8 >= HIDWORD(v8) + v7 )
      {
        qmemcpy((void *)HIDWORD(v8), a1, v7);
        v10 = (pthread_cond_t *)ssedev;
        v11 = *(_DWORD *)(ssedev + 28) + v7;
      }
      else
      {
        qmemcpy((void *)HIDWORD(v8), a1, v8 - HIDWORD(v8));
        v9 = v7 - (v8 - HIDWORD(v8));
        qmemcpy(*(void **)(ssedev + 32), &a1[v8 - HIDWORD(v8)], v9);
        v10 = (pthread_cond_t *)ssedev;
        v11 = *(_DWORD *)(ssedev + 32) + v9;
      }
      v10[7].__private[0] = v11;
      v10[4].__private[0] += v7;
      pthread_cond_signal(v10 + 11);
      v4 = ssedev;
      a2 -= v7;
      v5 = 0;
      if ( a2 )
      {
        a1 += v7;
        if ( !*(_DWORD *)(ssedev + 4) )
          continue;
      }
      goto LABEL_15;
    }
    _android_log_print(
      3,
      "sound_trigger_hal",
      "%s: buffering stopped while waiting on cond, exiting",
      "sse_write_pcm_data");
    v4 = ssedev;
    v5 = -5;
  }
LABEL_15:
  pthread_mutex_unlock((pthread_mutex_t *)(v4 + 48));
  return v5;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// FBB4: using guessed type int ssedev;

//----- (00006924) --------------------------------------------------------
int __fastcall sse_read_pcm_data(char *a1, size_t a2)
{
  int v4; // r6
  int v5; // r0
  size_t v6; // r7
  int v7; // r0
  __int64 v8; // kr00_8
  size_t v9; // r6
  pthread_cond_t *v10; // r0
  size_t v11; // r1
  struct timespec tp; // [sp+8h] [bp-30h] BYREF

  v4 = 0;
  tp.tv_sec = 0;
  tp.tv_nsec = 0;
  pthread_mutex_lock((pthread_mutex_t *)(ssedev + 48));
  v5 = ssedev;
  if ( a2 && !*(_DWORD *)(ssedev + 4) )
  {
    while ( 1 )
    {
      v6 = *(_DWORD *)(v5 + 16);
      if ( !v6 )
      {
        clock_gettime(0, &tp);
        tp.tv_sec += 2;
        v7 = pthread_cond_timedwait((pthread_cond_t *)(ssedev + 44), (pthread_mutex_t *)(ssedev + 48), &tp);
        if ( v7 )
        {
          _android_log_print(6, "sound_trigger_hal", "%s: ERROR. read wait timed out, ret %d", "sse_read_pcm_data", v7);
          v5 = ssedev;
          v4 = -5;
          *(_DWORD *)(ssedev + 4) = 1;
          break;
        }
        v5 = ssedev;
        if ( *(_DWORD *)(ssedev + 4) )
        {
          _android_log_print(
            3,
            "sound_trigger_hal",
            "%s: buffering stopped while waiting on cond, exiting",
            "sse_read_pcm_data");
          v5 = ssedev;
          v4 = -5;
          break;
        }
        v6 = *(_DWORD *)(ssedev + 16);
      }
      v8 = *(_QWORD *)(v5 + 20);
      if ( a2 < v6 )
        v6 = a2;
      if ( HIDWORD(v8) >= (unsigned int)v8 + v6 )
      {
        qmemcpy(a1, (const void *)v8, v6);
        v10 = (pthread_cond_t *)ssedev;
        v11 = *(_DWORD *)(ssedev + 20) + v6;
      }
      else
      {
        qmemcpy(a1, (const void *)v8, HIDWORD(v8) - v8);
        v9 = v6 - (HIDWORD(v8) - v8);
        qmemcpy(&a1[HIDWORD(v8) - v8], *(const void **)(ssedev + 32), v9);
        v10 = (pthread_cond_t *)ssedev;
        v11 = *(_DWORD *)(ssedev + 32) + v9;
      }
      v10[5].__private[0] = v11;
      v10[4].__private[0] -= v6;
      pthread_cond_signal(v10 + 11);
      v5 = ssedev;
      a2 -= v6;
      v4 = 0;
      if ( a2 )
      {
        a1 += v6;
        if ( !*(_DWORD *)(ssedev + 4) )
          continue;
      }
      break;
    }
  }
  pthread_mutex_unlock((pthread_mutex_t *)(v5 + 48));
  return v4;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// FBB4: using guessed type int ssedev;

//----- (00006A7C) --------------------------------------------------------
int __fastcall sva_read_pcm(char *a1, signed int a2)
{
  int state; // r3
  int v5; // r7
  int v6; // r1
  int v7; // r2
  int v8; // r4
  signed int v9; // r6
  int pcm_data; // r6
  char *v12; // r1

  state = j_pcm_get_state();
  v5 = head_length;
  v6 = ftt_length;
  v7 = *(_DWORD *)ssedev1;
  *(_DWORD *)ssedev1 += a2;
  v8 = v6 - v7 + v5;
  if ( v8 <= 0 )
  {
    if ( state != 1 )
    {
      pcm_data = j_sse_read_pcm_data(a1, a2);
      goto LABEL_12;
    }
LABEL_8:
    _android_log_print(6, "sound_trigger_hal", "Not in Buffering state, state %d", state);
    return -5;
  }
  v9 = a2;
  if ( v8 < a2 )
    v9 = v6 - v7 + v5;
  if ( state != 2 )
    goto LABEL_8;
  pthread_mutex_lock((pthread_mutex_t *)(ssedev + 48));
  if ( *(_DWORD *)(ssedev + 4) )
  {
    _android_log_print(6, "sound_trigger_hal", "%s: No active buffering", "sva_read_pcm");
    pthread_mutex_unlock((pthread_mutex_t *)(ssedev + 48));
    return -5;
  }
  pthread_mutex_unlock((pthread_mutex_t *)(ssedev + 48));
  v12 = (char *)&sAudioHeader - head_length + 320;
  if ( v9 <= head_length )
  {
    qmemcpy(a1, v12, v9);
    _android_log_print(6, "sound_trigger_hal", "offset %d,  read %d", 320 - head_length, v9);
    head_length -= v9;
    return v9;
  }
  qmemcpy(a1, v12, head_length);
  pcm_data = j_sse_read_pcm_data1(&a1[head_length], v9 - head_length);
  head_length = 0;
  if ( v8 < a2 )
  {
    j_sse_read_pcm_data(&a1[v8], 640 - v8);
    a2 = v8;
  }
LABEL_12:
  if ( pcm_data )
    return pcm_data;
  return a2;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// FA6C: using guessed type int ftt_length;
// FA70: using guessed type int head_length;
// FA74: using guessed type int sAudioHeader;
// FBB4: using guessed type int ssedev;
// FBB8: using guessed type int ssedev1;

//----- (00006BCC) --------------------------------------------------------
int sse_dump_pcm_data()
{
  __int64 v0; // kr00_8
  unsigned int v1; // r1
  size_t v2; // r8
  int v3; // r0
  int v4; // r5
  int v5; // r0
  __int64 v6; // kr08_8

  pthread_mutex_lock((pthread_mutex_t *)(ssedev + 48));
  v0 = *(_QWORD *)(ssedev + 16);
  v1 = *(_DWORD *)(ssedev + 24);
  if ( v1 >= HIDWORD(v0) + (int)v0 )
  {
    if ( file_wakeup )
      fwrite((const void *)HIDWORD(v0), 1u, v0, (FILE *)file_wakeup);
    v5 = ssedev;
    v6 = *(_QWORD *)(ssedev + 16);
    *(_DWORD *)(ssedev + 16) = v6 - v0;
    *(_DWORD *)(v5 + 20) = HIDWORD(v6) + v0;
    _android_log_print(6, "sound_trigger_hal", "copy %d bytes", (_DWORD)v0);
  }
  else
  {
    v2 = v1 - HIDWORD(v0);
    if ( file_wakeup )
    {
      fwrite((const void *)HIDWORD(v0), 1u, v2, (FILE *)file_wakeup);
      if ( file_wakeup )
        fwrite(*(const void **)(ssedev + 32), 1u, v0 - v2, (FILE *)file_wakeup);
    }
    v3 = ssedev;
    v4 = *(_DWORD *)(ssedev + 32) + v0 - v2;
    *(_DWORD *)(ssedev + 16) -= v0;
    *(_DWORD *)(v3 + 20) = v4;
    _android_log_print(6, "sound_trigger_hal", "part1 %d, part2 %d", v2, (_DWORD)v0 - v2);
  }
  pthread_mutex_unlock((pthread_mutex_t *)(ssedev + 48));
  return 0;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// F8E0: using guessed type int file_wakeup;
// FBB4: using guessed type int ssedev;

//----- (00006C94) --------------------------------------------------------
unsigned int __fastcall update_wr_rt_ptr(int a1, int a2)
{
  pthread_mutex_t *v4; // r0
  unsigned int v5; // r1
  unsigned int v6; // r3
  unsigned int v7; // r6
  unsigned int v8; // r12
  unsigned int v9; // r5
  unsigned int v10; // r5
  unsigned int v11; // r4
  unsigned int v12; // r1
  int v13; // r2
  int v14; // r6
  unsigned int v15; // r4
  int v16; // r2

  _android_log_print(4, "sound_trigger_hal", " %s", "update_wr_rt_ptr");
  pthread_mutex_lock((pthread_mutex_t *)(ssedev + 48));
  v4 = (pthread_mutex_t *)ssedev;
  v6 = *(_DWORD *)(ssedev + 32);
  v5 = *(_DWORD *)(ssedev + 28);
  v7 = v6 + a2;
  v8 = *(_DWORD *)(ssedev + 12);
  v9 = v5 - a2;
  if ( v7 > v5 )
    v9 = v5 + v8 - a1;
  if ( v6 + a1 > v9 )
    v9 += v8;
  v10 = v9 - a1;
  v11 = v10 - v6;
  if ( (int)(v10 - v6) < 16000 )
  {
    if ( *(_DWORD *)(ssedev + 16) >= v8 )
    {
      v16 = *(_DWORD *)(ssedev + 24) + v11 - 16000;
      *(_DWORD *)(ssedev + 16) = v5 + v8 - v16;
      v4[5].__private[0] = v16;
      goto LABEL_15;
    }
    v12 = v5 - v6;
    v13 = (unsigned __int64)(1717986919LL * (int)v11) >> 32;
  }
  else
  {
    v6 = v10 - 16000;
    if ( v5 > v10 )
    {
      *(_DWORD *)(ssedev + 16) = v5 - v6;
      v4[5].__private[0] = v6;
LABEL_15:
      v15 = 500;
      goto LABEL_16;
    }
    LOWORD(v14) = 26215;
    if ( v6 < v5 )
      v6 = *(_DWORD *)(ssedev + 28);
    HIWORD(v14) = 26214;
    v13 = (unsigned __int64)((int)(v10 - v6) * (__int64)v14) >> 32;
    v12 = v5 + v8 - v6;
  }
  *(_DWORD *)(ssedev + 16) = v12;
  v4[5].__private[0] = v6;
  v15 = 10 * (((v13 >> 6) + ((unsigned int)v13 >> 31)) >> 1);
LABEL_16:
  pthread_mutex_unlock(v4 + 12);
  return v15;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// FBB4: using guessed type int ssedev;

//----- (00006D68) --------------------------------------------------------
int init_wr_rt_ptr()
{
  pthread_mutex_t *v0; // r0
  __int64 v1; // kr00_8

  pthread_mutex_lock((pthread_mutex_t *)(ssedev + 48));
  v0 = (pthread_mutex_t *)ssedev;
  v1 = *(_QWORD *)(ssedev + 8);
  *(_DWORD *)(ssedev + 16) = 0;
  v0[5].__private[0] = v1;
  v0[6].__private[0] = HIDWORD(v1) + v1;
  v0[7].__private[0] = v1;
  v0[8].__private[0] = v1;
  return _ThumbV7PILongThunk_pthread_mutex_unlock(v0 + 12);
}
// FBB4: using guessed type int ssedev;

//----- (00006D9C) --------------------------------------------------------
int __fastcall sse_process(void *src, int a2, void *dest, size_t n)
{
  int result; // r0

  qmemcpy(dest, src, n);
  result = j_pcm_get_state();
  if ( result == 2 )
  {
    j_mxe_process((char *)dest, n);
    return _ThumbV7PILongThunk_sse_write_pcm_data((char *)dest, n);
  }
  else if ( result == 1 )
  {
    j_mxe_process((char *)dest, n);
    return _ThumbV7PILongThunk_save_pcm_data((char *)dest, n);
  }
  return result;
}

//----- (00006DE4) --------------------------------------------------------
int platform_init()
{
  gmixer = mixer_open(0);
  if ( !gmixer )
    return -1;
  _android_log_print(3, "sound_trigger_hal", "open mixer success");
  return 0;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 7F80: using guessed type int __fastcall mixer_open(_DWORD);
// A8A8: using guessed type int gmixer;

//----- (00006E1C) --------------------------------------------------------
int __fastcall set_mixer_int(const char *name, int value)
{
  int ctl_by_name; // r0

  _android_log_print(3, "sound_trigger_hal", "set mixer %s,  %d", name, value);
  ctl_by_name = mixer_get_ctl_by_name(gmixer, name);
  mixer_ctl_set_value(ctl_by_name, 0, value);
  return 0;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 7F90: using guessed type int __fastcall mixer_get_ctl_by_name(_DWORD, _DWORD);
// 7FA0: using guessed type int __fastcall mixer_ctl_set_value(_DWORD, _DWORD, _DWORD);
// A8A8: using guessed type int gmixer;

//----- (00006E60) --------------------------------------------------------
int __fastcall set_mixer_string(const char *a1, const char *a2)
{
  int ctl_by_name; // r0

  _android_log_print(3, "sound_trigger_hal", "set mixer %s,  %s", a1, a2);
  ctl_by_name = mixer_get_ctl_by_name(gmixer, a1);
  mixer_ctl_set_enum_by_string(ctl_by_name, a2);
  return 0;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 7F90: using guessed type int __fastcall mixer_get_ctl_by_name(_DWORD, _DWORD);
// 7FB0: using guessed type int __fastcall mixer_ctl_set_enum_by_string(_DWORD, _DWORD);
// A8A8: using guessed type int gmixer;

//----- (00006EA0) --------------------------------------------------------
int __fastcall set_mixer_array(int a1, int *a2, int a3)
{
  int v6; // r4
  int *v7; // r6
  int v8; // t1
  int ctl_by_name; // r0

  if ( a3 >= 1 )
  {
    v6 = 0;
    v7 = a2;
    do
    {
      v8 = *v7++;
      _android_log_print(3, "sound_trigger_hal", "set mixer %s,  %ld", a1, v8);
      ++v6;
    }
    while ( v6 != a3 );
  }
  ctl_by_name = mixer_get_ctl_by_name(gmixer, a1);
  mixer_ctl_set_array(ctl_by_name, a2, a3);
  return 0;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 7F90: using guessed type int __fastcall mixer_get_ctl_by_name(_DWORD, _DWORD);
// 7FC0: using guessed type int __fastcall mixer_ctl_set_array(_DWORD, _DWORD, _DWORD);
// A8A8: using guessed type int gmixer;

//----- (00006F00) --------------------------------------------------------
int __fastcall set_mixer_path(const char *a1, int a2)
{
  j_set_mixer_int(a1, a2);
  return 0;
}

//----- (00006F0C) --------------------------------------------------------
int enable_ref_device()
{
  return _ThumbV7PILongThunk_set_mixer_string("AUDIO_REF_EC_UL2 MUX", "PRI_MI2S_TX");
}

//----- (00006F20) --------------------------------------------------------
int disable_ref_device()
{
  return _ThumbV7PILongThunk_set_mixer_string("AUDIO_REF_EC_UL2 MUX", "None");
}

//----- (00006F34) --------------------------------------------------------
int __fastcall set_mic_path(int a1)
{
  return _ThumbV7PILongThunk_set_mixer_int("MultiMedia5 Mixer INT2_MI2S_TX", a1);
}

//----- (00006F44) --------------------------------------------------------
int enable_top_mic()
{
  j_set_mixer_int("ADC3 Volume", 6);
  j_set_mixer_string("DEC3 MUX", "ADC3");
  j_set_mixer_string("ADC2 MUX", "INP3");
  return _ThumbV7PILongThunk_set_mixer_string("INT2_MI2S_TX Channels", "One");
}

//----- (00006F94) --------------------------------------------------------
int disable_top_mic()
{
  j_set_mixer_int("ADC3 Volume", 4);
  j_set_mixer_string("DEC3 MUX", "ZERO");
  return _ThumbV7PILongThunk_set_mixer_string("INT2_MI2S_TX Channels", "One");
}

//----- (00006FD0) --------------------------------------------------------
int enable_headset_mic()
{
  j_set_mixer_int("ADC2 Volume", 6);
  j_set_mixer_string("DEC3 MUX", "ADC2");
  j_set_mixer_string("ADC2 MUX", "INP2");
  return _ThumbV7PILongThunk_set_mixer_string("INT2_MI2S_TX SampleRate", "KHZ_16");
}

//----- (00007020) --------------------------------------------------------
int disable_headset_mic()
{
  j_set_mixer_int("ADC2 Volume", 4);
  j_set_mixer_string("DEC3 MUX", "ZERO");
  return _ThumbV7PILongThunk_set_mixer_string("INT2_MI2S_TX SampleRate", "KHZ_48");
}

//----- (00007060) --------------------------------------------------------
int send_app_type()
{
  int ctl_by_name; // r0
  int v1; // r5
  __int64 v3[64]; // [sp+8h] [bp-218h] BYREF
  int v4; // [sp+208h] [bp-18h]

  memset(v3, 0, sizeof(v3));
  ctl_by_name = mixer_get_ctl_by_name(gmixer, "Audio Stream Capture 13 App Type Cfg");
  if ( ctl_by_name )
  {
    v1 = ctl_by_name;
    v3[0] = loc_70E0;
    v3[1] = loc_70E8;
    _android_log_print(6, "sound_trigger_hal", "set send_app_type ");
    mixer_ctl_set_array(v1, v3, 4);
  }
  else
  {
    _android_log_print(
      6,
      "sound_trigger_hal",
      "%s: Could not get ctl for mixer cmd - %s",
      "send_app_type",
      "Audio Stream Capture 13 App Type Cfg");
  }
  return _stack_chk_guard - v4;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 7F90: using guessed type int __fastcall mixer_get_ctl_by_name(_DWORD, _DWORD);
// 7FC0: using guessed type int __fastcall mixer_ctl_set_array(_DWORD, _DWORD, _DWORD);
// A8A8: using guessed type int gmixer;
// 7060: using guessed type _QWORD var_218[64];

//----- (00007110) --------------------------------------------------------
int send_barge_in_app_type()
{
  int ctl_by_name; // r0
  int v1; // r5
  __int64 v3[64]; // [sp+8h] [bp-218h] BYREF
  int v4; // [sp+208h] [bp-18h]

  memset((int)v3, 0, sizeof(v3));
  ctl_by_name = mixer_get_ctl_by_name(gmixer, "Audio Stream Capture 13 App Type Cfg");
  if ( ctl_by_name )
  {
    v1 = ctl_by_name;
    v3[0] = loc_7190;
    v3[1] = loc_7198;
    _android_log_print(6, "sound_trigger_hal", "set send_app_type ");
    mixer_ctl_set_array(v1, v3, 4);
  }
  else
  {
    _android_log_print(
      6,
      "sound_trigger_hal",
      "%s: Could not get ctl for mixer cmd - %s",
      "send_barge_in_app_type",
      "Audio Stream Capture 13 App Type Cfg");
  }
  return _stack_chk_guard - v4;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 7F90: using guessed type int __fastcall mixer_get_ctl_by_name(_DWORD, _DWORD);
// 7FC0: using guessed type int __fastcall mixer_ctl_set_array(_DWORD, _DWORD, _DWORD);
// A8A8: using guessed type int gmixer;
// 7110: using guessed type _QWORD var_218[64];

//----- (000071C0) --------------------------------------------------------
int __fastcall mxe_load_sound_model(int a1, unsigned int a2)
{
  int v3; // r0

  if ( a2 > 0x5000 || a2 < 0x100 )
    return -1;
  v3 = _memcpy_chk(&dword_A8AC, a1, a2, 20480);
  j_mxe_create(v3);
  return 0;
}
// 7FF0: using guessed type int __fastcall _memcpy_chk(_DWORD, _DWORD, _DWORD, _DWORD);
// A8AC: using guessed type int dword_A8AC;

//----- (000071F0) --------------------------------------------------------
int load_sound_module()
{
  FILE *v0; // r0
  FILE *v1; // r4
  size_t v2; // r6

  _android_log_print(4, "sound_trigger_hal", "Begain sound module");
  v0 = fopen("/vendor/etc/sm.bin", "rb");
  if ( v0 )
  {
    v1 = v0;
    v2 = fread_unlocked(&dword_A8AC, 4u, 0x1400u, v0);
    fclose(v1);
    if ( dword_A8AC + 4 == 4 * v2 )
    {
      _android_log_print(4, "sound_trigger_hal", "load sound module sucess");
      return 0;
    }
    _android_log_print(6, "sound_trigger_hal", "Blob size mismatch\n");
  }
  else
  {
    _android_log_print(6, "sound_trigger_hal", "Open blob file %s failed\n", "/vendor/etc/sm.bin");
  }
  return -1;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// A8AC: using guessed type int dword_A8AC;

//----- (00007298) --------------------------------------------------------
int mxe_reset()
{
  int result; // r0

  _android_log_print(4, "sound_trigger_hal", "mxe reset handle(%p)", (const void *)paddy_task);
  if ( paddy_task )
  {
    PaddyEngineStopTask(paddy_task, paddy_engine);
    paddy_task = 0;
  }
  paddy_task = PaddyEngineCreateTask(paddy_engine);
  result = 0;
  partial_size = 0;
  return result;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 8020: using guessed type int __fastcall PaddyEngineStopTask(_DWORD, _DWORD);
// 8030: using guessed type int __fastcall PaddyEngineCreateTask(_DWORD);
// F8B0: using guessed type int partial_size;
// F8B4: using guessed type int paddy_task;
// F8B8: using guessed type int paddy_engine;

//----- (000072E8) --------------------------------------------------------
int mxe_create()
{
  _android_log_print(4, "sound_trigger_hal", "mxe_create");
  partial_buffer = (int)malloc(0x140u);
  partial_size = 0;
  return 0;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// F8AC: using guessed type int partial_buffer;
// F8B0: using guessed type int partial_size;

//----- (00007328) --------------------------------------------------------
int mxe_init()
{
  int v0; // r0
  char version[48]; // [sp+0h] [bp-50h] BYREF
  __int16 v3; // [sp+30h] [bp-20h]

  v0 = _android_log_print(4, "sound_trigger_hal", "mix init");
  paddy_engine = PaddyEngineCreate(v0);
  PaddyEngineInit();
  paddy_task = PaddyEngineCreateTask(paddy_engine);
  memset(version, 0, sizeof(version));
  v3 = 0;
  PaddyEngineGetModelVersion(paddy_engine, version);
  _android_log_print(4, "sound_trigger_hal", "Wakeup Model Version: %s\n", version);
  return 0;
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 8030: using guessed type int __fastcall PaddyEngineCreateTask(_DWORD);
// 8050: using guessed type int PaddyEngineInit(void);
// 8060: using guessed type int __fastcall PaddyEngineGetModelVersion(_DWORD, _DWORD);
// F8B4: using guessed type int paddy_task;
// F8B8: using guessed type int paddy_engine;

//----- (000073CC) --------------------------------------------------------
void mxe_deinit()
{
  if ( paddy_task )
    PaddyEngineStopTask(paddy_task, paddy_engine);
  PaddyEngineDestroy(paddy_engine);
  if ( partial_buffer )
    _ThumbV7PILongThunk_free((void *)partial_buffer);
}
// 8020: using guessed type int __fastcall PaddyEngineStopTask(_DWORD, _DWORD);
// 8070: using guessed type int __fastcall PaddyEngineDestroy(_DWORD);
// 92B0: using guessed type int *partial_buffer_ptr;
// F8AC: using guessed type int partial_buffer;
// F8B4: using guessed type int paddy_task;
// F8B8: using guessed type int paddy_engine;

//----- (00007408) --------------------------------------------------------
int __fastcall mxe_process(char *a1, int a2)
{
  size_t v4; // r6
  int v5; // r11
  int v6; // r6
  char *v7; // r8
  int state; // r0
  int v9; // r4
  int v10; // r5
  int updated; // r9
  unsigned int v12; // r6
  int *v13; // r5
  int v14; // r10
  int v15; // r7
  int v16; // r2
  int i; // r0
  int v18; // t1
  void ***v20; // [sp+10h] [bp-1D0h]
  size_t v21; // [sp+14h] [bp-1CCh]
  unsigned int n; // [sp+18h] [bp-1C8h]
  char *v23; // [sp+20h] [bp-1C0h]
  int v24; // [sp+24h] [bp-1BCh]
  char v25[72]; // [sp+30h] [bp-1B0h] BYREF
  char v26[320]; // [sp+78h] [bp-168h] BYREF
  int v27; // [sp+1B8h] [bp-28h]

  memset(v26, 0, sizeof(v26));
  v4 = partial_size;
  n = (partial_size + a2) % 0x140u;
  if ( partial_size )
    v4 = 320 - partial_size;
  if ( partial_size )
  {
    qmemcpy((void *)(partial_size + partial_buffer), a1, v4);
    memmove(a1, &a1[v4], a2 - v4);
  }
  v20 = (void ***)&partial_buffer_ptr;
  v21 = v4;
  v23 = a1;
  v24 = a2;
  if ( a2 >= 320 )
  {
    v5 = 0;
    v6 = 320 * (a2 / 320) - 320;
    v7 = a1;
    while ( 1 )
    {
      PaddyEngineProcessTask(v25, paddy_task, paddy_engine, v7, 320, v26, 320, 3, v20, v21);
      qmemcpy(&result, v25, 0x48u);
      state = j_pcm_get_state();
      if ( state == 2 )
      {
        j_sse_write_pcm_data1(v26, 0x140u);
      }
      else if ( state == 1 )
      {
        j_save_pcm_data1(v26, 0x140u);
      }
      if ( dword_FBC0 == 1 )
        break;
      if ( v5 )
      {
        v7 += 320;
      }
      else if ( !partial_size )
      {
        v7 += 320;
      }
      ++v5;
      v6 -= 320;
      if ( v5 == a2 / 320 )
        goto LABEL_21;
    }
    _android_log_print(4, "sound_trigger_hal", "PaddyProcess success, process_detection_event");
    j_pcm_set_state(2);
    v9 = 5 * (dword_FBD8 - unk_FBDC);
    v10 = 320 * (dword_FBD8 - unk_FBDC);
    updated = j_update_wr_rt_ptr1(v10, v6);
    v12 = j_update_wr_rt_ptr(v10, v6);
    v13 = &sAudioHeader;
    memset(&sAudioHeader, 0, 0x140u);
    v14 = 2 * v9 + 600;
    v15 = 0;
    sprintf(AEC, 600, v16, updated, 2 * v9, 0, AEC, v14 + v12);
    for ( i = 0; i != 79; ++i )
    {
      v18 = *v13++;
      v15 ^= v18;
    }
    head_length = 320;
    unk_FBB0 = v15;
    ftt_length = 320 * ((v14 + updated) / 10);
    _android_log_print(
      4,
      "sound_trigger_hal",
      "startTimeMs, %d lengthMs %d, wakeupScore %d, pcm_lengthMs %d",
      updated,
      2 * v9,
      0,
      v14 + v12);
    j_wakeup_call_back();
  }
LABEL_21:
  partial_size = n;
  if ( n )
    qmemcpy(**v20, &v23[v24 - v21 - n], n);
  return _stack_chk_guard - v27;
}
// 74E2: variable 'v20' is possibly undefined
// 74E2: variable 'v21' is possibly undefined
// 75AA: variable 'v16' is possibly undefined
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);
// 8090: using guessed type int __fastcall PaddyEngineProcessTask(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 92B0: using guessed type int *partial_buffer_ptr;
// F8AC: using guessed type int partial_buffer;
// F8B0: using guessed type int partial_size;
// F8B4: using guessed type int paddy_task;
// F8B8: using guessed type int paddy_engine;
// F8BC: using guessed type int AEC;
// FA6C: using guessed type int ftt_length;
// FA70: using guessed type int head_length;
// FA74: using guessed type int sAudioHeader;
// FBC0: using guessed type int dword_FBC0;
// FBD8: using guessed type int dword_FBD8;

//----- (00007680) --------------------------------------------------------
int sprintf(int a1, int a2, int a3, ...)
{
  int v4; // [sp+8h] [bp-18h]
  int v5; // [sp+8h] [bp-18h]
  int v6; // [sp+Ch] [bp-14h]
  int v7; // [sp+10h] [bp-10h]
  va_list va; // [sp+1Ch] [bp-4h] BYREF

  va_start(va, a3);
  _vsprintf_chk(
    &sAudioHeader,
    0,
    320,
    "FMT:1;VENDOR:NUANCE;START:%d;FTT_LENGTH:%d;SCORE:%d;AEC:%d;PCM_LENGTH:%d",
    va,
    va,
    v4,
    v6,
    v7);
  return _stack_chk_guard - v5;
}
// 76AA: variable 'v4' is possibly undefined
// 76AA: variable 'v6' is possibly undefined
// 76AA: variable 'v7' is possibly undefined
// 76B2: variable 'v5' is possibly undefined
// 7A80: using guessed type int _vsprintf_chk(_DWORD, _DWORD, _DWORD, const char *, ...);
// FA74: using guessed type int sAudioHeader;

//----- (000078B8) --------------------------------------------------------
int __fastcall sub_78B8(unsigned int a1, unsigned int a2, int a3, int a4)
{
  if ( a1 >= a2 )
    ++a4;
  return a4;
}

//----- (000078D8) --------------------------------------------------------
void *__fastcall _aeabi_memset8(void *a1, size_t n, int c)
{
  return memset(a1, c, n);
}

//----- (000078E8) --------------------------------------------------------
void *__fastcall _aeabi_memclr8(void *a1, size_t n)
{
  return memset(a1, 0, n);
}

//----- (00007900) --------------------------------------------------------
int _ThumbV7PILongThunk_enable_headset_mic()
{
  return j_enable_headset_mic();
}

//----- (0000790C) --------------------------------------------------------
int _ThumbV7PILongThunk_enable_top_mic()
{
  return j_enable_top_mic();
}

//----- (00007918) --------------------------------------------------------
int _ThumbV7PILongThunk_disable_headset_mic()
{
  return j_disable_headset_mic();
}

//----- (00007924) --------------------------------------------------------
int _ThumbV7PILongThunk_disable_top_mic()
{
  return j_disable_top_mic();
}

//----- (00007930) --------------------------------------------------------
int _ThumbV7PILongThunk___android_log_print(int a1, int a2, const char *a3, ...)
{
  return _android_log_print(a1, a2, a3);
}
// 79D0: using guessed type int _android_log_print(_DWORD, _DWORD, const char *, ...);

//----- (0000793C) --------------------------------------------------------
int __fastcall _ThumbV7PILongThunk_fclose(FILE *stream)
{
  return fclose(stream);
}

//----- (00007948) --------------------------------------------------------
int __fastcall _ThumbV7PILongThunk_pthread_mutex_unlock(pthread_mutex_t *mutex)
{
  return pthread_mutex_unlock(mutex);
}

//----- (00007954) --------------------------------------------------------
void __fastcall _ThumbV7PILongThunk_free(void *ptr)
{
  free(ptr);
}

//----- (00007960) --------------------------------------------------------
int __fastcall _ThumbV7PILongThunk_init_wr_rt_ptr1(int a1)
{
  return j_init_wr_rt_ptr1(a1);
}

//----- (0000796C) --------------------------------------------------------
int __fastcall _ThumbV7PILongThunk_save_pcm_data(char *a1, size_t a2)
{
  return j_save_pcm_data(a1, a2);
}

//----- (00007978) --------------------------------------------------------
int __fastcall _ThumbV7PILongThunk_sse_write_pcm_data(char *a1, size_t a2)
{
  return j_sse_write_pcm_data(a1, a2);
}

//----- (00007984) --------------------------------------------------------
int __fastcall _ThumbV7PILongThunk_set_mixer_string(const char *a1, const char *a2)
{
  return j_set_mixer_string(a1, a2);
}

//----- (00007990) --------------------------------------------------------
int __fastcall _ThumbV7PILongThunk_set_mixer_int(const char *name, int value)
{
  return j_set_mixer_int(name, value);
}

//----- (000079A0) --------------------------------------------------------
void sub_79A0()
{
  JUMPOUT(0);
}
// 79AC: control flows out of bounds to 0

//----- (000079E0) --------------------------------------------------------
// attributes: thunk
int j_enable_headset_mic()
{
  return enable_headset_mic();
}

//----- (000079F0) --------------------------------------------------------
// attributes: thunk
int j_enable_top_mic()
{
  return enable_top_mic();
}

//----- (00007A00) --------------------------------------------------------
// attributes: thunk
int j_disable_headset_mic()
{
  return disable_headset_mic();
}

//----- (00007A10) --------------------------------------------------------
// attributes: thunk
int j_disable_top_mic()
{
  return disable_top_mic();
}

//----- (00007A40) --------------------------------------------------------
// attributes: thunk
void *__fastcall j___aeabi_memclr8(void *a1, size_t n)
{
  return memset(a1, 0, n);
}

//----- (00007AB0) --------------------------------------------------------
// attributes: thunk
int j_swtich_device()
{
  return swtich_device();
}

//----- (00007AC0) --------------------------------------------------------
// attributes: thunk
int j_sse_get_mic_channel()
{
  return sse_get_mic_channel();
}

//----- (00007AD0) --------------------------------------------------------
// attributes: thunk
int j_enable_ref_device()
{
  return enable_ref_device();
}

//----- (00007AE0) --------------------------------------------------------
// attributes: thunk
int __fastcall j_set_device_enable(int a1, int a2)
{
  return set_device_enable(a1, a2);
}

//----- (00007AF0) --------------------------------------------------------
// attributes: thunk
int j_send_barge_in_app_type()
{
  return send_barge_in_app_type();
}

//----- (00007B00) --------------------------------------------------------
// attributes: thunk
int j_send_app_type()
{
  return send_app_type();
}

//----- (00007B10) --------------------------------------------------------
// attributes: thunk
int __fastcall j_set_mic_path(int a1)
{
  return set_mic_path(a1);
}

//----- (00007B70) --------------------------------------------------------
// attributes: thunk
int j_disable_ref_device()
{
  return disable_ref_device();
}

//----- (00007BA0) --------------------------------------------------------
// attributes: thunk
void *__fastcall j___aeabi_memclr8_0(void *a1, size_t n)
{
  return memset(a1, 0, n);
}

//----- (00007BB0) --------------------------------------------------------
// attributes: thunk
void *__fastcall j___aeabi_memcpy8(void *dest, const void *src, size_t n)
{
  return qmemcpy(dest, src, n);
}

//----- (00007BC0) --------------------------------------------------------
// attributes: thunk
int __fastcall j_exit_buffer_state()
{
  return exit_buffer_state();
}

//----- (00007C00) --------------------------------------------------------
// attributes: thunk
int __fastcall j_platform_init(int a1)
{
  return platform_init();
}

//----- (00007C10) --------------------------------------------------------
// attributes: thunk
int j_sse_get_ref_channel()
{
  return sse_get_ref_channel();
}

//----- (00007C30) --------------------------------------------------------
// attributes: thunk
int j_sse_get_frame_size()
{
  return sse_get_frame_size();
}

//----- (00007C90) --------------------------------------------------------
// attributes: thunk
int j_sse_init()
{
  return sse_init();
}

//----- (00007CA0) --------------------------------------------------------
// attributes: thunk
int j_mxe_init()
{
  return mxe_init();
}

//----- (00007CB0) --------------------------------------------------------
// attributes: thunk
int j_platform_info_get()
{
  return platform_info_get();
}

//----- (00007CC0) --------------------------------------------------------
// attributes: thunk
void j_mxe_deinit()
{
  mxe_deinit();
}

//----- (00007CD0) --------------------------------------------------------
// attributes: thunk
int j_sse_deinit()
{
  return sse_deinit();
}

//----- (00007CE0) --------------------------------------------------------
// attributes: thunk
int __fastcall j_pcm_set_state(int a1)
{
  return pcm_set_state(a1);
}

//----- (00007D20) --------------------------------------------------------
// attributes: thunk
int j_pcm_get_state()
{
  return pcm_get_state();
}

//----- (00007D30) --------------------------------------------------------
// attributes: thunk
int __fastcall j_sse_reset(int a1)
{
  return sse_reset(a1);
}

//----- (00007D40) --------------------------------------------------------
// attributes: thunk
int j_mxe_reset()
{
  return mxe_reset();
}

//----- (00007D50) --------------------------------------------------------
// attributes: thunk
int j_open_dump_file()
{
  return open_dump_file();
}

//----- (00007D70) --------------------------------------------------------
// attributes: thunk
void *__fastcall j_packet_to_planer(__int16 *a1, _WORD *a2, int a3)
{
  return packet_to_planer(a1, a2, a3);
}

//----- (00007D90) --------------------------------------------------------
// attributes: thunk
int __fastcall j_sse_process(void *src, int a2, void *dest, size_t n)
{
  return sse_process(src, a2, dest, n);
}

//----- (00007DA0) --------------------------------------------------------
// attributes: thunk
int j_close_dump_file()
{
  return close_dump_file();
}

//----- (00007DB0) --------------------------------------------------------
// attributes: thunk
int j_close_pcm_device()
{
  return close_pcm_device();
}

//----- (00007DD0) --------------------------------------------------------
// attributes: thunk
int j_clear_buffer_state()
{
  return clear_buffer_state();
}

//----- (00007DE0) --------------------------------------------------------
// attributes: thunk
int j_open_pcm_device()
{
  return open_pcm_device();
}

//----- (00007DF0) --------------------------------------------------------
// attributes: thunk
int __fastcall j_sva_read_pcm(char *a1, signed int a2)
{
  return sva_read_pcm(a1, a2);
}

//----- (00007E00) --------------------------------------------------------
// attributes: thunk
int j_pcm_start_read()
{
  return pcm_start_read();
}

//----- (00007E10) --------------------------------------------------------
// attributes: thunk
int j_pcm_stop_read()
{
  return pcm_stop_read();
}

//----- (00007E20) --------------------------------------------------------
// attributes: thunk
int __fastcall j_pcm_transfer_to_barge_in(int a1)
{
  return pcm_transfer_to_barge_in(a1);
}

//----- (00007E30) --------------------------------------------------------
// attributes: thunk
int __fastcall j_handle_device_switch(int a1, int a2)
{
  return handle_device_switch(a1, a2);
}

//----- (00007E40) --------------------------------------------------------
// attributes: thunk
int j_pcm_pause_read()
{
  return pcm_pause_read();
}

//----- (00007E50) --------------------------------------------------------
// attributes: thunk
int j_pcm_handle_reset()
{
  return pcm_handle_reset();
}

//----- (00007E60) --------------------------------------------------------
// attributes: thunk
int __fastcall j_pcm_handle_ssr(int a1)
{
  return pcm_handle_ssr(a1);
}

//----- (00007E70) --------------------------------------------------------
// attributes: thunk
int __fastcall j_pcm_resume_read(int a1)
{
  return pcm_resume_read(a1);
}

//----- (00007E80) --------------------------------------------------------
// attributes: thunk
int j_sound_trigger_pcm_close()
{
  return sound_trigger_pcm_close();
}

//----- (00007EA0) --------------------------------------------------------
// attributes: thunk
int __fastcall j_sound_trigger_pcm_open(uint32_t a1)
{
  return sound_trigger_pcm_open(a1);
}

//----- (00007EC0) --------------------------------------------------------
// attributes: thunk
int __fastcall j_mxe_load_sound_model(int a1, unsigned int a2)
{
  return mxe_load_sound_model(a1, a2);
}

//----- (00007ED0) --------------------------------------------------------
// attributes: thunk
void *__fastcall j___aeabi_memcpy8_0(void *dest, const void *src, size_t n)
{
  return qmemcpy(dest, src, n);
}

//----- (00007EE0) --------------------------------------------------------
// attributes: thunk
int __fastcall j_init_wr_rt_ptr(int a1)
{
  return init_wr_rt_ptr();
}

//----- (00007EF0) --------------------------------------------------------
// attributes: thunk
int __fastcall j_init_wr_rt_ptr1(int a1)
{
  return init_wr_rt_ptr1();
}

//----- (00007F30) --------------------------------------------------------
// attributes: thunk
int __fastcall j_sse_read_pcm_data(char *a1, size_t a2)
{
  return sse_read_pcm_data(a1, a2);
}

//----- (00007F40) --------------------------------------------------------
// attributes: thunk
int __fastcall j_sse_read_pcm_data1(char *a1, size_t a2)
{
  return sse_read_pcm_data1(a1, a2);
}

//----- (00007F50) --------------------------------------------------------
// attributes: thunk
int __fastcall j_mxe_process(char *a1, int a2)
{
  return mxe_process(a1, a2);
}

//----- (00007F60) --------------------------------------------------------
// attributes: thunk
int __fastcall j_save_pcm_data(char *a1, size_t a2)
{
  return save_pcm_data(a1, a2);
}

//----- (00007F70) --------------------------------------------------------
// attributes: thunk
int __fastcall j_sse_write_pcm_data(char *a1, size_t a2)
{
  return sse_write_pcm_data(a1, a2);
}

//----- (00007FD0) --------------------------------------------------------
// attributes: thunk
int __fastcall j_set_mixer_int(const char *name, int value)
{
  return set_mixer_int(name, value);
}

//----- (00007FE0) --------------------------------------------------------
// attributes: thunk
int __fastcall j_set_mixer_string(const char *a1, const char *a2)
{
  return set_mixer_string(a1, a2);
}

//----- (00008000) --------------------------------------------------------
// attributes: thunk
int __fastcall j_mxe_create(int a1)
{
  return mxe_create();
}

//----- (00008080) --------------------------------------------------------
// attributes: thunk
void *__fastcall j___aeabi_memmove8(void *dest, const void *src, size_t n)
{
  return memmove(dest, src, n);
}

//----- (000080A0) --------------------------------------------------------
// attributes: thunk
void *__fastcall j___aeabi_memcpy8_1(void *dest, const void *src, size_t n)
{
  return qmemcpy(dest, src, n);
}

//----- (000080B0) --------------------------------------------------------
// attributes: thunk
int __fastcall j_save_pcm_data1(char *a1, size_t a2)
{
  return save_pcm_data1(a1, a2);
}

//----- (000080C0) --------------------------------------------------------
// attributes: thunk
int __fastcall j_sse_write_pcm_data1(char *a1, size_t a2)
{
  return sse_write_pcm_data1(a1, a2);
}

//----- (000080D0) --------------------------------------------------------
// attributes: thunk
int __fastcall j_update_wr_rt_ptr1(int a1, int a2)
{
  return update_wr_rt_ptr1(a1, a2);
}

//----- (000080E0) --------------------------------------------------------
// attributes: thunk
unsigned int __fastcall j_update_wr_rt_ptr(int a1, int a2)
{
  return update_wr_rt_ptr(a1, a2);
}

//----- (000080F0) --------------------------------------------------------
// attributes: thunk
int j_wakeup_call_back()
{
  return wakeup_call_back();
}

//----- (00008110) --------------------------------------------------------
void *_aeabi_memcpy8_0(void *dest, const void *src, size_t n)
{
  return memcpy(dest, src, n);
}

//----- (00008120) --------------------------------------------------------
void *_aeabi_memmove8_0(void *dest, const void *src, size_t n)
{
  return memmove(dest, src, n);
}

// nfuncs=277 queued=166 decompiled=166 lumina nreq=0 worse=0 better=0
// ALL OK, 166 function(s) have been successfully decompiled
